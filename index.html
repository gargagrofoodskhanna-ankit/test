
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grain Procurement System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 90%;
            
        
            max-width: 450px;
        }
        .dropdown-container {
            position: relative;
        }
        .dropdown-list {
            position: absolute;
            z-index: 50;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            list-style: none;
            padding: 0;
            margin-top: 4px;
        }
        .dropdown-list li {
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dropdown-list li:hover {
            background-color: #f3f4f6;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .print-container, .print-container * {
                visibility: visible;
            }
            .print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
        .header-bg {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            border-radius: 1.5rem 1.5rem 0 0;
        }
        .shadow-custom {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05), 0 6px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Consistent width for all main sections */
        #mainView, #reportsView, #adminView {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            min-height: 400px; /* Prevent height jumping too */
        }

        /* Ensure tables don't cause width issues */
        .overflow-x-auto {
            max-width: 100%;
        }

        /* Consistent table minimum width */
        .min-w-full {
            min-width: 800px;
        }

        /* Fix admin tab content width consistency */
        .admin-tab-content {
            max-width: 1200px !important;
            margin: 0 auto;
            width: 100%;
            min-height: 400px;
        }

        /* Ensure admin tables are properly constrained */
        .admin-tab-content .overflow-x-auto {
            max-width: 100%;
            overflow-x: auto;
        }

        .admin-tab-content .min-w-full {
            min-width: 1000px; /* Allow table to be wider than container */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Login to Grain Procurement System</h2>
            <form id="loginForm" class="flex flex-col gap-4">
                <div>
                    <label for="usernameInput" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="usernameInput" placeholder="Enter username" required
                           class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="passwordInput" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="passwordInput" placeholder="Enter password" required
                           class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full p-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                    Login
                </button>
            </form>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <div class="bg-white rounded-3xl shadow-custom w-full max-w-7xl">
            <div class="header-bg text-white rounded-t-3xl p-6 md:p-8 text-center shadow-inner">
                <div class="flex justify-between items-center mb-2">
                    <h1 class="text-3xl md:text-4xl font-bold">Grain Procurement System</h1>
                    <button id="logoutBtn" class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition-colors">
                        Logout
                    </button>
                </div>
                <p class="text-sm opacity-80">Record and track grain purchases in real-time.</p>
            </div>
        <div class="p-6 md:p-8">
            

            <!-- Sync Status and Manual Sync Button -->
            <div id="syncStatus" class="text-center mb-4">
                <div class="flex items-center justify-center gap-2">
                    <span id="syncStatusText" class="text-sm text-gray-600"></span>
                    <button id="manualSyncBtn" class="hidden px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors">
                        Retry Sync
                    </button>
                </div>
            </div>

            <!-- Success/Error Notification -->
            <div id="notification" class="hidden fixed top-4 right-4 z-50 max-w-sm">
                <div class="bg-white rounded-lg shadow-lg border-l-4 p-4">
                    <div class="flex items-center">
                        <div id="notificationIcon" class="flex-shrink-0">
                            <!-- Icon will be added by JavaScript -->
                        </div>
                        <div class="ml-3">
                            <p id="notificationMessage" class="text-sm font-medium text-gray-900"></p>
                        </div>
                        <button id="closeNotification" class="ml-auto pl-3">
                            <span class="sr-only">Close</span>
                            <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- View Toggler -->
            <div class="flex justify-center gap-4 mb-6">
                <button id="recordViewBtn" class="px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white shadow-md transition-colors duration-200 hover:bg-blue-700">Record</button>
                <button id="reportsViewBtn" class="px-6 py-2 rounded-lg font-semibold bg-gray-200 text-gray-800 shadow-md transition-colors duration-200 hover:bg-gray-300">Reports</button>
                <button id="adminViewBtn" class="px-6 py-2 rounded-lg font-semibold bg-gray-200 text-gray-800 shadow-md transition-colors duration-200 hover:bg-gray-300 hidden">Admin</button>
            </div>
            
            <!-- Main Form & List View -->
            <div id="mainView">
                <!-- Add Gate Pass Form -->
                <form id="addGatePassForm" class="flex flex-col gap-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="gatepassTypeSelect" class="block text-sm font-medium text-gray-700">Gate Pass Type</label>
                            <select id="gatepassTypeSelect" class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="Incoming">Incoming</option>
                                <option value="Outgoing">Outgoing</option>
                            </select>
                        </div>
                        <div>
                            <label for="itemSelect" class="block text-sm font-medium text-gray-700">Item</label>
                            <select id="itemSelect" class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="Maize">Maize</option>
                                <option value="Wheat">Wheat</option>
                                <option value="Rice">Rice</option>
                            </select>
                        </div>
                        <div>
                            <label for="supplierSelect" class="block text-sm font-medium text-gray-700">Purchased From</label>
                            <select id="supplierSelect" required
                                class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select a party...</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <div>
                            <label for="truckNumber" class="block text-sm font-medium text-gray-700">Truck Number</label>
                            <input type="text" id="truckNumber" placeholder="Truck Number" required
                                class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                        </div>
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                            <div class="relative">
                                <input type="date" id="date" required
                                    class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                                <button type="button" id="datePickerBtn" 
                                    class="absolute right-2 top-1/2 transform -translate-y-1/2 p-2 text-gray-400 hover:text-gray-600 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label for="partyWeight" class="block text-sm font-medium text-gray-700">Party Weight (quintal)</label>
                            <input type="number" id="partyWeight" placeholder="Party Weight" step="0.01" min="0" required
                                class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
                        </div>
                        <div>
                            <label for="ownWeight" class="block text-sm font-medium text-gray-700">Own Weight (quintal)</label>
                            <input type="number" id="ownWeight" placeholder="Own Weight" step="0.01" min="0" required
                                class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
                        </div>
                    </div>
                    <div>
                        <label for="remarks" class="block text-sm font-medium text-gray-700">Remarks</label>
                        <textarea id="remarks" placeholder="Enter any additional remarks or notes..." rows="3"
                            class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow resize-vertical"></textarea>
                    </div>
                    <button type="submit" id="saveGatePassBtn"
                            class="w-full p-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors shadow-md mt-2">
                        <span id="saveBtnText">Save Gate Pass</span>
                        <span id="saveBtnSpinner" class="hidden">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Saving...
                        </span>
                    </button>
                </form>

                <!-- Gate Pass List -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">Last 5 Gate Passes</h2>
                    <ul id="gatePassList" class="space-y-3">
                        <!-- Gate Passes will be rendered here by JavaScript -->
                    </ul>
                </div>
            </div>

            <!-- Reports View -->
            <div id="reportsView" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">Gate Pass Reports</h2>
                
                <!-- Gate Pass Type Selection -->
                <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <h3 class="text-lg font-semibold mb-4">Select Gate Pass Type</h3>
                    <div class="flex justify-center">
                        <div class="bg-gray-100 p-1 rounded-lg">
                            <button id="outgoingReportsTab" class="px-6 py-2 rounded-md font-medium text-sm transition-colors bg-blue-600 text-white">
                                Outgoing Gate Passes
                            </button>
                            <button id="incomingReportsTab" class="px-6 py-2 rounded-md font-medium text-sm transition-colors text-gray-600 hover:text-gray-800">
                                Incoming Gate Passes
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Outgoing Gate Pass Details Section -->
                <div id="outgoingReportsContent" class="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <h3 class="text-lg font-semibold mb-4">Outgoing Gate Pass Details Management</h3>
                    
                    <!-- Filter for outgoing gate passes -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Filter Outgoing Gate Passes</label>
                            <button id="refreshOutgoingReportsBtn" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                ðŸ”„ Refresh
                            </button>
                        </div>
                        <select id="outgoingFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">All Outgoing Gate Passes</option>
                            <option value="incomplete" selected>Incomplete Details</option>
                            <option value="complete">Complete Details</option>
                        </select>
                        <div id="outgoingFilterStatus" class="mt-2 text-sm text-gray-600">
                            <!-- Status will be updated dynamically -->
                        </div>
                    </div>
                    
                    <!-- List of outgoing gate passes with edit capability -->
                    <div id="outgoingGatePassList" class="space-y-4">
                        <!-- Dynamic list items will be populated here -->
                    </div>
                </div>
                
                <!-- Incoming Gate Pass Details Section -->
                <div id="incomingReportsContent" class="bg-white p-6 rounded-lg shadow-sm mb-6 hidden">
                    <h3 class="text-lg font-semibold mb-4">Incoming Gate Pass Details Management</h3>
                    
                    <!-- Filter for incoming gate passes -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Filter Incoming Gate Passes</label>
                            <button id="refreshIncomingReportsBtn" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                ðŸ”„ Refresh
                            </button>
                        </div>
                        <select id="incomingFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">All Incoming Gate Passes</option>
                            <option value="incomplete" selected>Incomplete Details</option>
                            <option value="complete">Complete Details</option>
                        </select>
                        <div id="incomingFilterStatus" class="mt-2 text-sm text-gray-600">
                            <!-- Status will be updated dynamically -->
                        </div>
                    </div>
                    
                    <!-- List of incoming gate passes with edit capability -->
                    <div id="incomingGatePassList" class="space-y-4">
                        <!-- Dynamic list items will be populated here -->
                    </div>
                </div>
                
                <!-- Gate Passes Table Section -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800">All Gate Passes</h3>
                            <span id="gatePassCount" class="text-sm text-gray-600">0 gate passes</span>
                        </div>
                    </div>
                    
                    <!-- Table Container -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gate Pass No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Party/Supplier</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Truck No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Party Weight</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Own Weight</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remarks</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="gatePassTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Table rows will be rendered here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Admin Panel</h2>
                
                <!-- Admin Tabs -->
                <div class="mb-6">
                    <div class="flex justify-center">
                        <div class="bg-gray-100 p-1 rounded-lg">
                            <button id="adminPaymentsTab" class="px-6 py-2 rounded-md font-medium text-sm transition-colors bg-blue-600 text-white">
                                Payments Management
                            </button>
                            <button id="adminPartiesTab" class="px-6 py-2 rounded-md font-medium text-sm transition-colors text-gray-600 hover:text-gray-800">
                                Party Management
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Payments Tab Content -->
                <div id="adminPaymentsContent" class="admin-tab-content max-w-none">

                    <!-- Enhanced Summary Cards with Progress Indicators -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gradient-to-br from-rose-25 to-rose-50 p-6 rounded-lg border border-rose-100 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-sm font-medium text-rose-700 mb-2">Overdue Payments</h4>
                                    <p id="overdueAmount" class="text-3xl font-bold text-rose-800">â‚¹0</p>
                                    <p id="overdueCount" class="text-xs text-rose-600 mt-1">0 payments</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-rose-100 rounded-full h-2">
                                    <div id="overdueProgress" class="bg-rose-400 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-amber-25 to-amber-50 p-6 rounded-lg border border-amber-100 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-sm font-medium text-amber-700 mb-2">Pending Payments</h4>
                                    <p id="pendingAmount" class="text-3xl font-bold text-amber-800">â‚¹0</p>
                                    <p id="pendingCount" class="text-xs text-amber-600 mt-1">0 payments</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-amber-100 rounded-full h-2">
                                    <div id="pendingProgress" class="bg-amber-400 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-orange-25 to-orange-50 p-6 rounded-lg border border-orange-100 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-sm font-medium text-orange-700 mb-2">Partial Payments</h4>
                                    <p id="partialAmount" class="text-3xl font-bold text-orange-800">â‚¹0</p>
                                    <p id="partialCount" class="text-xs text-orange-600 mt-1">0 payments</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-orange-100 rounded-full h-2">
                                    <div id="partialProgress" class="bg-orange-400 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-emerald-25 to-emerald-50 p-6 rounded-lg border border-emerald-100 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-sm font-medium text-emerald-700 mb-2">Received Payments</h4>
                                    <p id="receivedAmount" class="text-3xl font-bold text-emerald-800">â‚¹0</p>
                                    <p id="receivedCount" class="text-xs text-emerald-600 mt-1">0 payments</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-emerald-100 rounded-full h-2">
                                    <div id="receivedProgress" class="bg-emerald-400 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Search and Filter Panel -->
                    <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4 lg:mb-0">Payment Search & Filters</h4>
                            <div class="flex space-x-2">
                                <button onclick="clearAllFiltersEnhanced()" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                    Clear Filters
                                </button>
                                <button onclick="toggleAdvancedSearchEnhanced()" class="px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    Advanced Search
                                </button>
                            </div>
                        </div>
                        
                        <!-- Basic Filters -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                                <select id="paymentStatusFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="all">All Payments</option>
                                    <option value="pending">Pending Payments</option>
                                    <option value="partial">Partial Payments</option>
                                    <option value="overdue">Overdue Payments</option>
                                    <option value="received">Fully Received</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Broker</label>
                                <select id="brokerFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="all">All Brokers</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Due Date Range</label>
                                <input type="date" id="dueDateFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Amount Range</label>
                                <select id="amountRangeFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="all">All Amounts</option>
                                    <option value="0-10000">â‚¹0 - â‚¹10,000</option>
                                    <option value="10000-50000">â‚¹10,000 - â‚¹50,000</option>
                                    <option value="50000-100000">â‚¹50,000 - â‚¹1,00,000</option>
                                    <option value="100000+">Above â‚¹1,00,000</option>
                                </select>
                            </div>
                        </div>

                        <!-- Advanced Search Panel (Initially Hidden) -->
                        <div id="advancedSearchPanel" class="hidden border-t pt-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Search by Gate Pass ID</label>
                                    <input type="text" id="gatePassIdSearch" placeholder="Enter Gate Pass ID" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                                    <select id="paymentMethodFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="all">All Methods</option>
                                        <option value="cash">Cash</option>
                                        <option value="cheque">Cheque</option>
                                        <option value="bank_transfer">Bank Transfer</option>
                                        <option value="upi">UPI</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Days Overdue</label>
                                    <select id="overdueDaysFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="all">All</option>
                                        <option value="1-7">1-7 days</option>
                                        <option value="8-30">8-30 days</option>
                                        <option value="31-90">31-90 days</option>
                                        <option value="90+">90+ days</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Enhanced Payments Table -->
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                            <div class="flex justify-between items-center">
                                <h4 class="text-lg font-semibold text-gray-900">Payment Records</h4>
                                <div class="flex items-center space-x-4">
                                    <button onclick="addNewPaymentEnhanced()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
                                        + Add Payment
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-8 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider w-32">Gate Pass ID</th>
                                        <th class="px-8 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider w-48">Broker/Party</th>
                                        <th class="px-8 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider w-32">Grain Type</th>
                                        <th class="px-8 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider w-40">Amount (â‚¹)</th>
                                        <th class="px-8 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider w-32">Due Date</th>
                                        <th class="px-8 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider w-24">Status</th>
                                        <th class="px-8 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider w-32">Progress</th>
                                        <th class="px-8 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider w-32">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="duePaymentsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Dynamic rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Parties Tab Content -->
                <div id="adminPartiesContent" class="admin-tab-content hidden max-w-none">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold mb-4">Party Management</h3>
                        
                        <!-- Add New Party Form -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-medium mb-3">Add New Party</h4>
                            <form id="addPartyForm" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="newPartyName" class="block text-sm font-medium text-gray-700 mb-1">Party Name *</label>
                                        <input type="text" id="newPartyName" placeholder="Enter party name" required
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="newPartyCity" class="block text-sm font-medium text-gray-700 mb-1">City *</label>
                                        <input type="text" id="newPartyCity" placeholder="Enter city" required
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="newPartyState" class="block text-sm font-medium text-gray-700 mb-1">State *</label>
                                        <input type="text" id="newPartyState" placeholder="Enter state" required
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="newPartyGstPan" class="block text-sm font-medium text-gray-700 mb-1">GST/PAN Number *</label>
                                        <input type="text" id="newPartyGstPan" placeholder="Enter GST or PAN number" required
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label for="newPartyAddress" class="block text-sm font-medium text-gray-700 mb-1">Address *</label>
                                    <textarea id="newPartyAddress" placeholder="Enter complete address" required rows="3"
                                              class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                                <div class="flex justify-end gap-3">
                                    <button type="button" id="clearPartyForm" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                                        Clear
                                    </button>
                                    <button type="submit" id="addPartyBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        Add Party
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Party List -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-medium mb-3">Existing Parties</h4>
                            <div id="partyList" class="space-y-3 max-h-60 overflow-y-auto">
                                <!-- Parties will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Status Modal -->
    <div id="paymentStatusModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Update Payment Status</h2>
            <form id="paymentStatusForm">
                <input type="hidden" id="paymentGatePassId">
                
                <!-- Gate Pass Info (read-only) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Gate Pass ID</label>
                        <input type="text" id="paymentGatePassIdDisplay" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Amount</label>
                        <input type="text" id="paymentAmountDisplay" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Broker</label>
                        <input type="text" id="paymentBrokerDisplay" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Due Date</label>
                        <input type="text" id="paymentDueDateDisplay" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                </div>
                
                <!-- Payment History Section -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-3">Payment History</h4>
                    <div id="paymentHistoryList" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                        <!-- Payment history items will be populated here -->
                    </div>
                </div>

                <!-- Add New Payment Section -->
                <div class="border-t pt-4">
                    <h4 class="text-lg font-semibold mb-3">Add New Payment</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="paymentReceivedDate" class="block text-sm font-medium text-gray-700">Payment Received Date</label>
                            <input type="date" id="paymentReceivedDate" class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="amountReceived" class="block text-sm font-medium text-gray-700">Amount Received (â‚¹)</label>
                            <input type="number" id="amountReceived" step="0.01" min="0" placeholder="Enter amount received" class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="remainingAmount" class="block text-sm font-medium text-gray-700">Remaining Amount (â‚¹)</label>
                            <input type="text" id="remainingAmount" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                        </div>
                        <div>
                            <label for="paymentStatus" class="block text-sm font-medium text-gray-700">Current Status</label>
                            <input type="text" id="paymentStatusDisplay" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                        </div>
                        <div class="md:col-span-2">
                            <label for="paymentNotes" class="block text-sm font-medium text-gray-700">Payment Notes (Optional)</label>
                            <textarea id="paymentNotes" rows="2" placeholder="Enter any notes about this payment..." class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelPaymentStatus" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Update Status
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Outgoing Details Modal -->
    <div id="outgoingDetailsModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Edit Outgoing Gate Pass Details</h2>
            <form id="outgoingDetailsForm">
                <!-- Basic info (read-only) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Gate Pass ID</label>
                        <input type="text" id="outgoingGatePassId" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Item</label>
                        <input type="text" id="outgoingItem" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Sold To</label>
                        <input type="text" id="outgoingSoldTo" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Truck Number</label>
                        <input type="text" id="outgoingTruckNumber" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Own Weight (quintal)</label>
                        <input type="text" id="outgoingOwnWeight" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="text" id="outgoingDate" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                </div>
                
                <!-- Additional outgoing fields -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="outgoingItemRate" class="block text-sm font-medium text-gray-700">Rate per Quintal (â‚¹)</label>
                        <input type="number" id="outgoingItemRate" step="0.01" min="0" required
                               class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="outgoingBrokerName" class="block text-sm font-medium text-gray-700">Broker Name</label>
                        <input type="text" id="outgoingBrokerName" required
                               class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="outgoingPartyWeight" class="block text-sm font-medium text-gray-700">Party Weight (quintal)</label>
                        <input type="number" id="outgoingPartyWeight" step="0.01" min="0" required
                               class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="outgoingPaymentDueDays" class="block text-sm font-medium text-gray-700">Payment Due (Days)</label>
                        <input type="number" id="outgoingPaymentDueDays" placeholder="Enter days" min="1" max="365" required
                               class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Number of days from gate pass date</p>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelOutgoingDetails" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Save Details
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Incoming Details Modal -->
    <div id="incomingDetailsModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Edit Incoming Gate Pass Details</h2>
            <form id="incomingDetailsForm">
                <!-- Basic info (read-only) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Gate Pass ID</label>
                        <input type="text" id="incomingGatePassId" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Item</label>
                        <input type="text" id="incomingItem" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Purchased From</label>
                        <input type="text" id="incomingPurchasedFrom" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Truck Number</label>
                        <input type="text" id="incomingTruckNumber" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Party Weight (quintal)</label>
                        <input type="text" id="incomingPartyWeight" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Own Weight (quintal)</label>
                        <input type="text" id="incomingOwnWeight" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="text" id="incomingDate" readonly class="mt-1 block w-full p-3 rounded-lg border border-gray-300 bg-gray-100">
                    </div>
                </div>
                
                <!-- Additional incoming fields -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="incomingItemRate" class="block text-sm font-medium text-gray-700">Rate per Quintal (â‚¹)</label>
                        <input type="number" id="incomingItemRate" step="0.01" min="0" required
                               class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="incomingBrokerName" class="block text-sm font-medium text-gray-700">Broker Name</label>
                        <input type="text" id="incomingBrokerName" required
                               class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="incomingPaymentDueDays" class="block text-sm font-medium text-gray-700">Payment Due (Days)</label>
                        <input type="number" id="incomingPaymentDueDays" placeholder="Enter days" min="1" max="365" required
                               class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Number of days from gate pass date</p>
                    </div>
                    <div>
                        <label for="incomingRemarks" class="block text-sm font-medium text-gray-700">Additional Remarks</label>
                        <textarea id="incomingRemarks" rows="3" placeholder="Enter any additional remarks..."
                                  class="mt-1 block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-vertical"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelIncomingDetails" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Save Details
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Edit Gate Pass</h2>
            <form id="editForm" class="flex flex-col gap-4">
                <input type="hidden" id="editGatePassId">
                <label for="editGatepassTypeSelect" class="block text-sm font-medium text-gray-700">Gate Pass Type</label>
                <select id="editGatepassTypeSelect" class="block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="Incoming">Incoming</option>
                    <option value="Outgoing">Outgoing</option>
                </select>
                <label for="editItemSelect" class="block text-sm font-medium text-gray-700">Item</label>
                <select id="editItemSelect" class="block w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="Maize">Maize</option>
                    <option value="Wheat">Wheat</option>
                    <option value="Rice">Rice</option>
                </select>
                <div>
                    <label for="editSupplierSelect" class="block text-sm font-medium text-gray-700">Purchased From</label>
                    <select id="editSupplierSelect" required
                        class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select a party...</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <label for="editTruckNumber" class="block text-sm font-medium text-gray-700">Truck Number</label>
                <input type="text" id="editTruckNumber" required
                       class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <label for="editDate" class="block text-sm font-medium text-gray-700">Date</label>
                <div class="relative">
                    <input type="date" id="editDate" required
                           class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="button" id="editDatePickerBtn" 
                        class="absolute right-2 top-1/2 transform -translate-y-1/2 p-2 text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                </div>
                <label for="editPartyWeight" class="block text-sm font-medium text-gray-700">Party Weight (quintal)</label>
                <input type="number" id="editPartyWeight" step="0.01" min="0" required
                       class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
                <label for="editOwnWeight" class="block text-sm font-medium text-gray-700">Own Weight (quintal)</label>
                <input type="number" id="editOwnWeight" step="0.01" min="0" required
                       class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
                <label for="editRemarks" class="block text-sm font-medium text-gray-700">Remarks</label>
                <textarea id="editRemarks" placeholder="Enter any additional remarks or notes..." rows="3"
                    class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-vertical"></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" id="cancelEditButton" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition-colors">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, setDoc, getDoc, setLogLevel, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        console.log("âœ… Firebase SDKs loaded successfully");

        // Firebase Initialization - Fixed Configuration
        const appId = 'grain-procurement-system';
        const firebaseConfig = {
            apiKey: "AIzaSyBdjQoKx1ORU3gCvK5-JP6dGfg1xkqL8Lk",
            authDomain: "gatepass-146df.firebaseapp.com",
            projectId: "gatepass-146df",
            storageBucket: "gatepass-146df.firebasestorage.app",
            messagingSenderId: "343259089109",
            appId: "1:343259089109:web:6ed2be22cb568e5e053a5c",
            measurementId: "G-58KPYJ7EP1"
        };

        // Validate Firebase configuration
        console.log("ðŸ”§ Firebase Configuration Check:");
        console.log("API Key:", firebaseConfig.apiKey ? "âœ… Present" : "âŒ Missing");
        console.log("Auth Domain:", firebaseConfig.authDomain ? "âœ… Present" : "âŒ Missing");
        console.log("Project ID:", firebaseConfig.projectId ? "âœ… Present" : "âŒ Missing");
        console.log("Storage Bucket:", firebaseConfig.storageBucket ? "âœ… Present" : "âŒ Missing");
        console.log("Messaging Sender ID:", firebaseConfig.messagingSenderId ? "âœ… Present" : "âŒ Missing");
        console.log("App ID:", firebaseConfig.appId ? "âœ… Present" : "âŒ Missing");

        let app;
        let auth;
        let db;
        let userId;
        let userAuthReady = false;
        let allGatePasses = [];
        window.allGatePasses = allGatePasses;
        let currentUser = null;
        let userRole = null;

        // User authentication will be handled by Firebase
        // No hardcoded demo users for security
        
        // Function to create initial users in the database
        async function createInitialUsers() {
            try {
                const usersRef = collection(db, 'users');
                
                // Check if users already exist
                const existingUsers = await getDocs(usersRef);
                if (!existingUsers.empty) {
                    console.log("Users already exist in database");
                    return;
                }
                
                // Create initial users
                const initialUsers = [
                    {
                        username: 'admin',
                        password: 'admin123', // In production, use proper password hashing
                        name: 'Administrator',
                        role: 'admin',
                        email: 'admin@grainprocurement.com',
                        isActive: true,
                        createdAt: new Date()
                    },
                    {
                        username: 'user1',
                        password: 'user123', // In production, use proper password hashing
                        name: 'User One',
                        role: 'user1',
                        email: 'user1@grainprocurement.com',
                        isActive: true,
                        createdAt: new Date()
                    },
                    {
                        username: 'user2',
                        password: 'user123', // In production, use proper password hashing
                        name: 'User Two',
                        role: 'user2',
                        email: 'user2@grainprocurement.com',
                        isActive: true,
                        createdAt: new Date()
                    }
                ];
                
                // Add users to database
                for (const user of initialUsers) {
                    await addDoc(usersRef, user);
                    console.log(`Created user: ${user.username}`);
                }
                
                console.log("Initial users created successfully");
                showNotification("Initial users created in database", 'success');
                
            } catch (error) {
                console.error("Error creating initial users:", error);
                showNotification("Error creating initial users", 'error');
            }
        }

        // Function to register a new user
        async function registerUser(userData) {
            try {
                const usersRef = collection(db, 'users');
                
                // Check if username already exists
                const q = query(usersRef, where('username', '==', userData.username));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    showNotification("Username already exists", 'error');
                    return false;
                }
                
                // Add new user to database
                const newUser = {
                    username: userData.username,
                    password: userData.password, // In production, use proper password hashing
                    name: userData.name,
                    role: userData.role || 'user1',
                    email: userData.email || '',
                    isActive: true,
                    createdAt: new Date()
                };
                
                await addDoc(usersRef, newUser);
                console.log(`New user registered: ${userData.username}`);
                showNotification(`User ${userData.username} registered successfully`, 'success');
                return true;
                
            } catch (error) {
                console.error("Error registering user:", error);
                showNotification("Error registering user", 'error');
                return false;
            }
        }

        // Check if all required Firebase config fields are present
        const requiredFields = ['apiKey', 'authDomain', 'projectId', 'appId'];
        const missingFields = requiredFields.filter(field => !firebaseConfig[field]);
        
        if (missingFields.length > 0) {
            console.error("âŒ Firebase configuration incomplete!");
            console.error("Missing fields:", missingFields);
            showNotification("Firebase configuration incomplete. Using local storage only.", 'error');
            useLocalStorage = true;
        } else {
            try {
                console.log("ðŸ”§ Initializing Firebase with complete configuration...");
                console.log("ðŸ“ Project ID:", firebaseConfig.projectId);
                console.log("ðŸŒ Auth Domain:", firebaseConfig.authDomain);
                
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                console.log("âœ… Firebase app initialized");
                
                auth = getAuth(app);
                console.log("âœ… Firebase Auth initialized");
                
                db = getFirestore(app);
                console.log("âœ… Firestore initialized");
                
                setLogLevel('error'); // Reduce logging noise
                
                console.log("ðŸŽ‰ All Firebase services initialized successfully!");
                
                // Test Firebase connection with delay to ensure initialization
                setTimeout(() => {
                    testFirebaseConnection();
                }, 1500); // Increased delay for better reliability
                
                // Create initial users after Firebase is ready
                setTimeout(() => {
                    createInitialUsers();
                }, 3000); // Wait a bit more for Firebase to be fully ready
                
            } catch (e) {
                console.error("âŒ Firebase initialization failed:", e);
                console.error("Error type:", e.name);
                console.error("Error message:", e.message);
                console.error("Error stack:", e.stack);
                
                if (e.message.includes('app/duplicate-app')) {
                    console.error("ðŸ”„ Duplicate app error - trying to reinitialize");
                    showNotification("Firebase app already initialized", 'info');
                } else if (e.message.includes('auth/api-key-not-valid')) {
                    console.error("ðŸ”‘ Invalid API key");
                    showNotification("Invalid Firebase API key", 'error');
                } else if (e.message.includes('network')) {
                    console.error("ðŸŒ Network connectivity issue");
                    showNotification("Network error during Firebase initialization", 'error');
                } else {
                    showNotification(`Firebase initialization error: ${e.message}`, 'error');
                }
                
                useLocalStorage = true;
            }
        }

        // Test Firebase connection
        async function testFirebaseConnection() {
            try {
                console.log("ðŸ” Testing Firebase connection...");
                console.log("ðŸ”§ Auth service:", !!auth);
                console.log("ðŸ”§ Database service:", !!db);
                console.log("ðŸ”§ App instance:", !!app);
                
                // Wait a bit more for services to be ready
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 1: Test authentication
                console.log("ðŸ”‘ Step 1: Testing authentication...");
                if (!auth.currentUser) {
                    console.log("ðŸ” Signing in anonymously...");
                    const userCredential = await signInAnonymously(auth);
                    console.log("âœ… Anonymous authentication successful");
                    console.log("ðŸ‘¤ User ID:", userCredential.user.uid);
                } else {
                    console.log("âœ… Already authenticated");
                    console.log("ðŸ‘¤ User ID:", auth.currentUser.uid);
                }
                
                // Step 2: Test read access
                console.log("ðŸ“– Step 2: Testing read access...");
                try {
                    const testCollection = collection(db, 'test_read');
                    // Just accessing the collection reference
                    console.log("âœ… Read access confirmed");
                } catch (readError) {
                    console.error("âŒ Read access failed:", readError);
                    throw readError;
                }
                
                // Step 3: Test write access (most likely to fail)
                console.log("ðŸ“ Step 3: Testing write access...");
                const testDoc = {
                    test: true,
                    timestamp: new Date(),
                    message: "Connection test from Grain Procurement System",
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                const docRef = await addDoc(collection(db, 'connection_test'), testDoc);
                console.log("âœ… Write test successful! Doc ID:", docRef.id);
                
                // Step 4: Test delete access
                console.log("ðŸ§¹ Step 4: Testing delete access...");
                await deleteDoc(doc(db, 'connection_test', docRef.id));
                console.log("âœ… Delete test successful - test document cleaned up");
                
                console.log("ðŸŽ‰ Firebase connection test COMPLETELY SUCCESSFUL!");
                console.log("ðŸ”¥ All Firebase operations working correctly");
                showNotification("Firebase connected successfully! âœ…", 'success');
                
                // Firebase is working, don't use local storage fallback
                useLocalStorage = false;
                
            } catch (e) {
                console.error("âŒ Firebase connection test FAILED:", e);
                console.error("ðŸ” Error code:", e.code);
                console.error("ðŸ” Error message:", e.message);
                console.error("ðŸ” Full error object:", e);
                
                // Analyze specific error types
                if (e.code === 'permission-denied') {
                    console.error("ðŸš« PERMISSION DENIED!");
                    console.error("ðŸ’¡ SOLUTION: Update Firebase Security Rules to allow anonymous access");
                    console.error("ðŸ“‹ Add this rule to Firestore Security Rules:");
                    console.error("   rules_version = '2';");
                    console.error("   service cloud.firestore {");
                    console.error("     match /databases/{database}/documents {");
                    console.error("       match /{document=**} {");
                    console.error("         allow read, write: if true;");
                    console.error("       }");
                    console.error("     }");
                    console.error("   }");
                    showNotification("âŒ Firebase Permission Denied - Check Security Rules", 'error');
                    
                } else if (e.code === 'failed-precondition') {
                    console.error("âš™ï¸ FIREBASE PROJECT NOT READY");
                    console.error("ðŸ’¡ SOLUTION: Enable Firestore in Firebase Console");
                    showNotification("âŒ Firestore not enabled - Check Firebase Console", 'error');
                    
                } else if (e.code === 'unavailable') {
                    console.error("ðŸŒ FIREBASE SERVICE UNAVAILABLE");
                    console.error("ðŸ’¡ SOLUTION: Check internet connection or Firebase status");
                    showNotification("âŒ Firebase service unavailable", 'error');
                    
                } else if (e.message.includes('fetch')) {
                    console.error("ðŸŒ NETWORK ERROR");
                    console.error("ðŸ’¡ SOLUTION: Check internet connection");
                    showNotification("âŒ Network error - Check internet connection", 'error');
                    
                } else {
                    console.error("ðŸ”¥ UNKNOWN FIREBASE ERROR");
                    console.error("ðŸ’¡ SOLUTION: Check Firebase project configuration");
                    showNotification(`âŒ Firebase error: ${e.message}`, 'error');
                }
                
                // Cloud-only mode: Show error instead of fallback
                console.log("âŒ Firebase connection failed - Cloud-only mode active");
                showNotification("âŒ Cannot connect to cloud storage. Please check your internet connection and try again.", 'error');
                
            }
        }

        // Cloud-Only Storage Functions
        // Note: Local storage functions removed - all data must go through Firebase
        
        function showCloudOnlyError(operation) {
            const message = `âŒ ${operation} failed: Cloud storage connection required. Please check your internet connection and try again.`;
            showNotification(message, 'error');
            console.error(`Cloud-only mode: ${operation} blocked - Firebase connection required`);
        }
        
        function isCloudStorageAvailable() {
            return db && auth && userAuthReady;
        }
        
        // Generate auto-incrementing gate pass number
        async function generateGatePassNumber() {
            try {
                // Get current year for the format (25-26 for 2025-2026)
                const currentYear = new Date().getFullYear();
                const yearSuffix = currentYear.toString().slice(-2);
                const nextYearSuffix = (currentYear + 1).toString().slice(-2);
                const yearRange = `${yearSuffix}-${nextYearSuffix}`;
                
                // Reference to the counter document
                const counterRef = doc(db, 'counters', 'gatepass_counter');
                
                // Use Firebase transaction to atomically increment the counter
                const counterDoc = await getDoc(counterRef);
                
                let nextNumber = 1;
                if (counterDoc.exists()) {
                    const counterData = counterDoc.data();
                    nextNumber = (counterData.count || 0) + 1;
                }
                
                // Update the counter
                await setDoc(counterRef, { 
                    count: nextNumber,
                    lastUpdated: new Date().toISOString()
                }, { merge: true });
                
                // Format the gate pass number: AAF/25-26/0001
                const formattedNumber = `AAF/${yearRange}/${nextNumber.toString().padStart(4, '0')}`;
                
                console.log(`âœ… Generated gate pass number: ${formattedNumber}`);
                return formattedNumber;
                
            } catch (error) {
                console.error("âŒ Error generating gate pass number:", error);
                // Fallback to timestamp-based ID if counter fails
                const fallbackId = `AAF/25-26/${Date.now().toString().slice(-4)}`;
                console.log(`âš ï¸ Using fallback ID: ${fallbackId}`);
                return fallbackId;
            }
        }

        // Enhanced data validation for cloud-only mode
        function validateGatePassData(formData) {
            const errors = [];
            
            if (!formData.type || formData.type.trim() === '') {
                errors.push('Gate pass type is required');
            }
            
            if (!formData.item || formData.item.trim() === '') {
                errors.push('Item name is required');
            }
            
            if (!formData.purchasedFrom || formData.purchasedFrom.trim() === '') {
                errors.push('Supplier name is required');
            }
            
            if (!formData.truckNumber || formData.truckNumber.trim() === '') {
                errors.push('Truck number is required');
            }
            
            if (!formData.date) {
                errors.push('Date is required');
            }
            
            // Only require party weight for incoming items
            if (formData.type === 'Incoming' && (isNaN(formData.partyWeight) || formData.partyWeight <= 0)) {
                errors.push('Valid party weight is required for incoming items');
            }
            
            if (isNaN(formData.ownWeight) || formData.ownWeight <= 0) {
                errors.push('Valid own weight is required');
            }
            
            return errors;
        }
        
        // Network connectivity check
        function checkNetworkConnectivity() {
            return navigator.onLine;
        }
        
        
        // Initialize network monitoring
        function initializeNetworkMonitoring() {
            // Listen for online/offline events
            window.addEventListener('online', () => {
                console.log("ðŸŒ Network connection restored");
                showNotification("ðŸŒ Network connection restored", 'success');
            });
            
            window.addEventListener('offline', () => {
                console.log("ðŸ“¡ Network connection lost");
                showNotification("ðŸ“¡ Network connection lost - Cloud storage unavailable", 'error');
            });
        }
        
        // Enhanced error recovery
        function handleCloudError(error, operation) {
            console.error(`âŒ Cloud operation failed (${operation}):`, error);
            
            if (!checkNetworkConnectivity()) {
                showNotification("âŒ No internet connection. Please check your network and try again.", 'error');
                return;
            }
            
            if (error.code === 'permission-denied') {
                showNotification("âŒ Permission denied. Please contact administrator.", 'error');
            } else if (error.code === 'unavailable') {
                showNotification("âŒ Cloud service temporarily unavailable. Please try again later.", 'error');
            } else if (error.code === 'failed-precondition') {
                showNotification("âŒ Database not ready. Please contact administrator.", 'error');
            } else {
                showNotification(`âŒ ${operation} failed: ${error.message}`, 'error');
            }
        }

        // DOM elements
        const loginModal = document.getElementById('loginModal');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminViewBtn = document.getElementById('adminViewBtn');
        const adminView = document.getElementById('adminView');
        const recordViewBtn = document.getElementById('recordViewBtn');
        const reportsViewBtn = document.getElementById('reportsViewBtn');
        const mainView = document.getElementById('mainView');
        const reportsView = document.getElementById('reportsView');
        const addGatePassForm = document.getElementById('addGatePassForm');
        const gatePassList = document.getElementById('gatePassList');
        const supplierSelect = document.getElementById('supplierSelect');
        const editSupplierSelect = document.getElementById('editSupplierSelect');
        const newPartyName = document.getElementById('newPartyName');
        const newPartyCity = document.getElementById('newPartyCity');
        const newPartyState = document.getElementById('newPartyState');
        const newPartyAddress = document.getElementById('newPartyAddress');
        const newPartyGstPan = document.getElementById('newPartyGstPan');
        const addPartyBtn = document.getElementById('addPartyBtn');
        const addPartyForm = document.getElementById('addPartyForm');
        const clearPartyForm = document.getElementById('clearPartyForm');
        const partyList = document.getElementById('partyList');
        const gatepassTypeSelect = document.getElementById('gatepassTypeSelect');
        const gatePassTableBody = document.getElementById('gatePassTableBody');
        const gatePassCount = document.getElementById('gatePassCount');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');
        const notificationIcon = document.getElementById('notificationIcon');
        const closeNotification = document.getElementById('closeNotification');
        const saveGatePassBtn = document.getElementById('saveGatePassBtn');
        const saveBtnText = document.getElementById('saveBtnText');
        const saveBtnSpinner = document.getElementById('saveBtnSpinner');
        const syncStatusText = document.getElementById('syncStatusText');
        const manualSyncBtn = document.getElementById('manualSyncBtn');
        let allSuppliers = []; // For backward compatibility - stores just names
        let allParties = []; // Stores complete party data
        let useLocalStorage = false; // Fallback flag

        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const editGatePassIdInput = document.getElementById('editGatePassId');
        const editItemSelectInput = document.getElementById('editItemSelect');
        const editSupplierSearchInput = document.getElementById('editSupplierSearchInput');
        const editSupplierDropdownList = document.getElementById('editSupplierDropdownList');
        const editTruckNumberInput = document.getElementById('editTruckNumber');
        const editDateInput = document.getElementById('editDate');
        const editPartyWeightInput = document.getElementById('editPartyWeight');
        const editOwnWeightInput = document.getElementById('editOwnWeight');
        const editRemarks = document.getElementById('editRemarks');
        const remarks = document.getElementById('remarks');
        const editGatepassTypeSelect = document.getElementById('editGatepassTypeSelect');
        const cancelEditButton = document.getElementById('cancelEditButton');

        // Function to toggle party weight field visibility based on gate pass type
        function togglePartyWeightField() {
            const gatePassType = gatepassTypeSelect.value;
            const partyWeightField = document.getElementById('partyWeight');
            const partyWeightContainer = partyWeightField.parentElement;
            
            if (gatePassType === 'Outgoing') {
                partyWeightContainer.style.display = 'none';
                partyWeightField.required = false;
                partyWeightField.value = ''; // Clear the value
            } else {
                partyWeightContainer.style.display = 'block';
                partyWeightField.required = true;
            }
        }
        
        // Function to toggle edit modal party weight field visibility
        function toggleEditPartyWeightField() {
            const gatePassType = editGatepassTypeSelect.value;
            const editPartyWeightField = document.getElementById('editPartyWeight');
            const editPartyWeightContainer = editPartyWeightField.parentElement;
            
            if (gatePassType === 'Outgoing') {
                editPartyWeightContainer.style.display = 'none';
                editPartyWeightField.required = false;
                editPartyWeightField.value = ''; // Clear the value
            } else {
                editPartyWeightContainer.style.display = 'block';
                editPartyWeightField.required = true;
            }
        }

        // Notification Functions
        function showNotification(message, type = 'success') {
            notificationMessage.textContent = message;
            notificationIcon.innerHTML = '';
            
            if (type === 'success') {
                notification.className = 'fixed top-4 right-4 z-50 max-w-sm';
                notification.querySelector('.bg-white').className = 'bg-white rounded-lg shadow-lg border-l-4 border-green-400 p-4';
                notificationIcon.innerHTML = `
                    <svg class="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                `;
            } else if (type === 'error') {
                notification.className = 'fixed top-4 right-4 z-50 max-w-sm';
                notification.querySelector('.bg-white').className = 'bg-white rounded-lg shadow-lg border-l-4 border-red-400 p-4';
                notificationIcon.innerHTML = `
                    <svg class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                `;
            } else if (type === 'info') {
                notification.className = 'fixed top-4 right-4 z-50 max-w-sm';
                notification.querySelector('.bg-white').className = 'bg-white rounded-lg shadow-lg border-l-4 border-blue-400 p-4';
                notificationIcon.innerHTML = `
                    <svg class="h-6 w-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                `;
            }
            
            notification.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }

        // Safe date formatter to handle invalid dates
        const formatDate = (date) => {
            if (!date || isNaN(new Date(date).getTime())) {
                return 'N/A';
            }
            return new Date(date).toLocaleDateString();
        };

        // Safe display function for potentially undefined values
        const safeDisplay = (value, fallback = 'N/A') => {
            return value && value !== 'N/A' && value !== 'undefined' ? value : fallback;
        };

        function hideNotification() {
            notification.classList.add('hidden');
        }

        function setSaveButtonLoading(loading) {
            if (loading) {
                saveBtnText.classList.add('hidden');
                saveBtnSpinner.classList.remove('hidden');
                saveGatePassBtn.disabled = true;
                saveGatePassBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                saveBtnText.classList.remove('hidden');
                saveBtnSpinner.classList.add('hidden');
                saveGatePassBtn.disabled = false;
                saveGatePassBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Authentication Functions
        function showLoginModal() {
            loginModal.style.display = 'flex';
            mainApp.classList.add('hidden');
        }

        function hideLoginModal() {
            loginModal.style.display = 'none';
            mainApp.classList.remove('hidden');
        }

        async function login(username, password) {
            // Clear any previous error states
            clearLoginErrors();
            
            if (!username || !password) {
                showLoginError("Please enter both username and password");
                showNotification("Please enter both username and password", 'error');
                return false;
            }

            try {
                // Show loading state
                showNotification("Authenticating...", 'info');
                setLoginLoading(true);
                
                // Query the users collection in Firestore
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('username', '==', username));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    showLoginError("Username not found. Please check your username and try again.");
                    showNotification("Invalid username or password", 'error');
                    return false;
                }
                
                // Get the first matching user document
                const userDoc = querySnapshot.docs[0];
                const userData = userDoc.data();
                
                // Verify password (in production, use proper password hashing)
                if (userData.password === password) {
                    currentUser = {
                        id: userDoc.id,
                        username: userData.username,
                        name: userData.name,
                        role: userData.role,
                        email: userData.email || '',
                        isActive: userData.isActive !== false // Default to true if not specified
                    };
                    
                    // Check if user is active
                    if (!currentUser.isActive) {
                        showLoginError("Account is deactivated. Please contact administrator.");
                        showNotification("Account is deactivated. Please contact administrator.", 'error');
                        return false;
                    }
                    
                    userRole = currentUser.role;
                    hideLoginModal();
                    updateUIForUserRole();
                    setupAuthAndListener();
                    showNotification(`Welcome back, ${currentUser.name}!`, 'success');
                    return true;
                } else {
                    showLoginError("Incorrect password. Please check your password and try again.");
                    showNotification("Invalid username or password", 'error');
                    return false;
                }
                
            } catch (error) {
                console.error("Login error:", error);
                showLoginError("Login failed. Please check your connection and try again.");
                showNotification("Login failed. Please try again.", 'error');
                return false;
            } finally {
                setLoginLoading(false);
            }
        }

        // Helper functions for login error handling
        function showLoginError(message) {
            // Create or update error message element
            let errorElement = document.getElementById('loginError');
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.id = 'loginError';
                errorElement.className = 'mt-2 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm';
                // Insert after the login form
                const loginForm = document.getElementById('loginForm');
                loginForm.parentNode.insertBefore(errorElement, loginForm.nextSibling);
            }
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // Add red border to input fields
            const usernameInput = document.getElementById('usernameInput');
            const passwordInput = document.getElementById('passwordInput');
            usernameInput.classList.add('border-red-500');
            passwordInput.classList.add('border-red-500');
        }

        function clearLoginErrors() {
            // Hide error message
            const errorElement = document.getElementById('loginError');
            if (errorElement) {
                errorElement.style.display = 'none';
            }
            
            // Remove red borders from input fields
            const usernameInput = document.getElementById('usernameInput');
            const passwordInput = document.getElementById('passwordInput');
            usernameInput.classList.remove('border-red-500');
            passwordInput.classList.remove('border-red-500');
        }

        function setLoginLoading(loading) {
            const loginButton = document.querySelector('#loginForm button[type="submit"]');
            if (loading) {
                loginButton.disabled = true;
                loginButton.textContent = 'Authenticating...';
                loginButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                loginButton.disabled = false;
                loginButton.textContent = 'Login';
                loginButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function logout() {
            console.log("ðŸ” Logging out user...");
            
            // Clear user session data
            currentUser = null;
            userRole = null;
            userAuthReady = false;
            userId = null;
            
            // Clear application data arrays
            allGatePasses.length = 0;
            allSuppliers.length = 0;
            allParties.length = 0;
            
            // Clear UI displays
            gatePassList.innerHTML = '';
            gatePassTableBody.innerHTML = '';
            
            // Sign out from Firebase if authenticated
            if (auth && auth.currentUser) {
                auth.signOut().then(() => {
                    console.log("âœ… Firebase sign out successful");
                }).catch((error) => {
                    console.error("âŒ Firebase sign out error:", error);
                });
            }
            
            // Show login modal
            showLoginModal();
            
            // Reset UI to default state
            mainView.classList.remove('hidden');
            reportsView.classList.add('hidden');
            adminView.classList.add('hidden');
            recordViewBtn.classList.add('bg-blue-600', 'text-white');
            recordViewBtn.classList.remove('bg-gray-200', 'text-gray-800');
            reportsViewBtn.classList.remove('bg-blue-600', 'text-white');
            reportsViewBtn.classList.add('bg-gray-200', 'text-gray-800');
            adminViewBtn.classList.remove('bg-blue-600', 'text-white');
            adminViewBtn.classList.add('bg-gray-200', 'text-gray-800');
            
            
            
            // Show logout confirmation
            showNotification("âœ… Logged out successfully", 'success');
            console.log("âœ… Logout completed - all session data cleared");
        }

        function updateUIForUserRole() {
            if (!currentUser) return;


            // Show/hide admin button based on role
            if (userRole === 'admin') {
                adminViewBtn.classList.remove('hidden');
            } else {
                adminViewBtn.classList.add('hidden');
            }

            // Show/hide reports button based on role (admin and user2 can see reports)
            if (userRole === 'admin' || userRole === 'user2') {
                reportsViewBtn.classList.remove('hidden');
            } else {
                reportsViewBtn.classList.add('hidden');
            }

            // Update form permissions based on role
            updateFormPermissions();
        }

        function updateFormPermissions() {
            const canAdd = userRole === 'admin' || userRole === 'user1' || userRole === 'user2';
            const canEdit = userRole === 'admin' || userRole === 'user1' || userRole === 'user2';
            const canDelete = userRole === 'admin';

            // Enable/disable add form
            addGatePassForm.style.display = canAdd ? 'flex' : 'none';
            
            // Update gate pass list permissions
            const editButtons = document.querySelectorAll('button[onclick*="showEditModal"]');
            const deleteButtons = document.querySelectorAll('button[onclick*="deleteGatePass"]');
            
            editButtons.forEach(btn => {
                btn.style.display = canEdit ? 'block' : 'none';
            });
            
            deleteButtons.forEach(btn => {
                btn.style.display = canDelete ? 'block' : 'none';
            });
        }

        // Authentication and Data Listener
        async function setupAuthAndListener() {
            if (!auth || !db) {
                console.error("Firebase services are not initialized.");
                return;
            }
            console.log("ðŸ”§ Setting up authentication and listeners...");

            try {
                // Always authenticate with Firebase for data access
                if (!auth.currentUser) {
                    console.log("ðŸ”‘ Authenticating with Firebase...");
                    await signInAnonymously(auth);
                    console.log("âœ… Firebase authentication successful");
                }

                // Set user ID and mark as ready
                if (currentUser) {
                    userId = currentUser.username + '_' + currentUser.role;
                    console.log("ðŸ“ User authenticated with role:", currentUser.role);
                } else {
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                    console.log("ðŸ“ Anonymous user authenticated");
                }

                userAuthReady = true;

                // Start data listeners
                startRealtimeListeners();

                console.log("ðŸŽ‰ Authentication and setup complete!");

            } catch (error) {
                console.error("âŒ Authentication failed:", error);
                showNotification("âŒ Authentication failed. Cloud storage connection required.", 'error');
                
                // Cloud-only mode: Authentication failed
                userId = currentUser ? currentUser.username + '_' + currentUser.role : 'cloud_user';
                userAuthReady = false; // Mark as not ready for Firebase operations
                
                // Show cloud-only error
                showCloudOnlyError("Authentication");
            }
        }

        // Cloud-only data listeners
        function startRealtimeListeners() {
            console.log("ðŸ”„ Starting cloud-only data listeners...");
            
            // Check if cloud storage is available
            if (!isCloudStorageAvailable()) {
                showCloudOnlyError("Data loading");
                return;
            }
            
            try {
                // Real-time listener for Suppliers
                const suppliersRef = collection(db, 'suppliers');
                onSnapshot(suppliersRef, (snapshot) => {
                    allSuppliers.length = 0; // Clear existing data
                    allParties.length = 0; // Clear existing party data
                    snapshot.forEach(doc => {
                        const data = { id: doc.id, ...doc.data() };
                        allSuppliers.push(data.name); // For backward compatibility
                        allParties.push(data); // Store complete party data
                    });
                    console.log("âœ… Suppliers loaded from cloud:", allSuppliers.length);
                    console.log("âœ… Complete party data loaded:", allParties.length);
                    
                    // Update dropdowns when suppliers change
                    populateSupplierDropdowns();
                    
                    // Update party list in admin view if it's currently visible
                    if (!adminView.classList.contains('hidden')) {
                        renderPartyList();
                    }
                }, (error) => {
                    console.error("âŒ Error fetching suppliers from cloud:", error);
                    showNotification("âŒ Failed to load suppliers from cloud", 'error');
                });

                // Real-time listener for Gate Passes
                const gatePassesRef = collection(db, 'gate_passes');
                onSnapshot(gatePassesRef, (snapshot) => {
                    allGatePasses.length = 0; // Clear existing data
                    snapshot.forEach((doc) => {
                        const gatePass = { firebaseId: doc.id, ...doc.data() };
                        allGatePasses.push(gatePass);
                    });
                    
                    console.log("âœ… Gate passes loaded from cloud:", allGatePasses.length);
                    renderGatePasses(allGatePasses);
                    renderGatePassTable(allGatePasses);
                    
                    if (allGatePasses.length > 0) {
                        showNotification(`âœ… ${allGatePasses.length} gate passes loaded from cloud`, 'success');
                    }
                }, (error) => {
                    console.error("âŒ Error fetching gate passes from cloud:", error);
                    showNotification("âŒ Failed to load gate passes from cloud", 'error');
                });
                
            } catch (error) {
                console.error("âŒ Error setting up cloud listeners:", error);
                showCloudOnlyError("Data listener setup");
            }
        }

        // Cloud-only data loading (replaces local storage loading)
        function loadCloudData() {
            console.log("â˜ï¸ Loading data from cloud storage...");
            
            if (!isCloudStorageAvailable()) {
                showCloudOnlyError("Data loading");
                return;
            }
            
            // Load data from cloud
            loadDataFromCloud();
        }
        
        // Function to render gate passes based on a given array (limited to last 5)
        function renderGatePasses(passes) {
            gatePassList.innerHTML = '';
            if (passes.length === 0) {
                const noResults = document.createElement('li');
                noResults.className = "text-center text-gray-500 py-4";
                noResults.textContent = "No gate passes found.";
                gatePassList.appendChild(noResults);
                return;
            }

            // Sort by creation date (newest first) and limit to last 5
            const sortedPasses = passes
                .sort((a, b) => new Date(b.createdAt || b.id) - new Date(a.createdAt || a.id))
                .slice(0, 5);

            sortedPasses.forEach((gatePass) => {
                const listItem = document.createElement('li');
                listItem.id = `gate-pass-${gatePass.id}`;
                listItem.className = "flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white p-3 rounded-lg shadow-sm border border-gray-200 gap-2 transition-shadow duration-200 hover:shadow-md";

                const gatePassDetails = document.createElement('div');
                gatePassDetails.className = "flex-1";
                gatePassDetails.innerHTML = `
                    <p class="font-bold text-gray-900">${gatePass.item}</p>
                    <p class="text-sm text-gray-600 font-mono">Gate Pass: <span class="font-bold text-blue-600">${gatePass.gatePassNumber || gatePass.id}</span></p>
                    <p class="text-sm text-gray-700">Type: <span class="font-medium">${gatePass.type}</span></p>
                    <p class="text-sm text-gray-700">Purchased From: <span class="font-medium">${gatePass.purchasedFrom}</span></p>
                    <p class="text-sm text-gray-700">Truck: <span class="font-medium">${gatePass.truckNumber}</span></p>
                    <p class="text-sm text-gray-700">Date: <span class="font-medium">${gatePass.date}</span></p>
                    ${gatePass.type === 'Incoming' ? `<p class="text-sm text-gray-700">Party Weight: <span class="font-medium">${gatePass.partyWeight} quintal</span></p>` : ''}
                    <p class="text-sm text-gray-700">Own Weight: <span class="font-medium">${gatePass.ownWeight} quintal</span></p>
                    ${gatePass.remarks ? `<p class="text-sm text-gray-700 mt-2"><span class="font-medium">Remarks:</span> <span class="italic">${gatePass.remarks}</span></p>` : ''}
                `;

                // Container for buttons
                const buttonContainer = document.createElement('div');
                buttonContainer.className = "flex gap-2 self-end sm:self-center";

                // Edit button (role-based)
                const canEdit = userRole === 'admin' || userRole === 'user1' || userRole === 'user2';
                if (canEdit) {
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.className = "p-2 bg-gray-500 text-white text-xs font-semibold rounded-lg hover:bg-gray-600 transition-colors duration-200";
                    // Use firebaseId if available, otherwise use the regular id
                    const actualDocId = gatePass.firebaseId || gatePass.id;
                    editButton.onclick = () => showEditModal(actualDocId, gatePass);
                    buttonContainer.appendChild(editButton);
                }

                // Delete button (admin only)
                const canDelete = userRole === 'admin';
                if (canDelete) {
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.className = "p-2 bg-red-500 text-white text-xs font-semibold rounded-lg hover:bg-red-600 transition-colors duration-200";
                    // Use firebaseId if available, otherwise use the regular id
                    const actualDocId = gatePass.firebaseId || gatePass.id;
                    deleteButton.onclick = () => deleteGatePass(actualDocId);
                    buttonContainer.appendChild(deleteButton);
                }

                // Print button
                const printButton = document.createElement('button');
                printButton.textContent = 'Print';
                printButton.className = "p-2 bg-blue-500 text-white text-xs font-semibold rounded-lg hover:bg-blue-600 transition-colors duration-200";
                printButton.onclick = () => printGatePass(gatePass);

                buttonContainer.appendChild(printButton);
                listItem.appendChild(gatePassDetails);
                listItem.appendChild(buttonContainer);
                gatePassList.appendChild(listItem);
            });
        }
        
        // Search functionality removed - only showing last 5 gate passes

        function calculateAndRenderInventory(gatePasses) {
            const inventory = {};
            const itemTypes = ['Maize', 'Wheat', 'Rice'];

            itemTypes.forEach(item => {
                inventory[item] = { incoming: 0, outgoing: 0 };
            });

            gatePasses.forEach(pass => {
                if (inventory[pass.item]) {
                    if (pass.type === 'Incoming') {
                        inventory[pass.item].incoming += pass.ownWeight;
                    } else if (pass.type === 'Outgoing') {
                        inventory[pass.item].outgoing += pass.ownWeight;
                    }
                }
            });

            renderGatePassTable(allGatePasses);
        }
        

        // Function to render gate passes in table format
        function renderGatePassTable(gatePasses) {
            gatePassTableBody.innerHTML = '';
            gatePassCount.textContent = `${gatePasses.length} gate passes`;

            if (gatePasses.length === 0) {
                gatePassTableBody.innerHTML = `
                    <tr>
                        <td colspan="12" class="px-6 py-8 text-center text-gray-500">
                            No gate passes found. Add some gate passes to see the report.
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort by creation date (newest first)
            const sortedPasses = [...gatePasses].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            sortedPasses.forEach((gatePass) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Format creation date
                const createdDate = new Date(gatePass.createdAt).toLocaleString();
                
                // Get user display name
                const userDisplay = gatePass.userId && gatePass.userId !== 'anonymous' ? 
                    `${gatePass.userId} (${gatePass.userRole || 'user'})` : 
                    'Anonymous User';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono font-bold text-blue-600">
                        ${gatePass.gatePassNumber || gatePass.id}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${gatePass.type === 'Incoming' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${gatePass.type}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${gatePass.item}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${gatePass.purchasedFrom}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${gatePass.truckNumber}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${gatePass.date}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${gatePass.type === 'Incoming' ? 
                            `${gatePass.partyWeight} quintal` : 
                            (gatePass.outgoingPartyWeight ? `${gatePass.outgoingPartyWeight} quintal` : '-')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${gatePass.ownWeight} quintal
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate" title="${gatePass.remarks || ''}">
                        ${gatePass.remarks || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${gatePass.type === 'Outgoing' ? 
                            (isOutgoingDetailsComplete(gatePass) ? 
                                '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Complete</span>' : 
                                '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">Incomplete</span>') : 
                            gatePass.type === 'Incoming' ?
                                (isIncomingDetailsComplete(gatePass) ? 
                                    '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Complete</span>' : 
                                    '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">Incomplete</span>') :
                                '<span class="text-gray-400">-</span>'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <button onclick="editGatePassFromTable('${gatePass.id}')" 
                                class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors">
                            Edit
                        </button>
                    </td>
                `;
                
                gatePassTableBody.appendChild(row);
            });
        }


        // Populate supplier dropdowns with parties
        function populateSupplierDropdowns() {
            // Clear existing options
            supplierSelect.innerHTML = '<option value="">Select a party...</option>';
            editSupplierSelect.innerHTML = '<option value="">Select a party...</option>';
            
            // Sort parties by name for consistent ordering
            const sortedParties = [...allParties].sort((a, b) => a.name.localeCompare(b.name));
            
            // Add all parties as options with enhanced display
            sortedParties.forEach(party => {
                const displayText = `${party.name} - ${party.city}, ${party.state} (GST: ${party.gstPan})`;
                
                const option1 = document.createElement('option');
                option1.value = party.name;
                option1.textContent = displayText;
                supplierSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = party.name;
                option2.textContent = displayText;
                editSupplierSelect.appendChild(option2);
            });
        }

        // Add new party (Admin only)
        async function addNewParty() {
            const partyName = newPartyName.value.trim();
            const partyCity = newPartyCity.value.trim();
            const partyState = newPartyState.value.trim();
            const partyAddress = newPartyAddress.value.trim();
            const partyGstPan = newPartyGstPan.value.trim();
            
            // Validation
            if (!partyName) {
                showNotification("Please enter party name", 'error');
                newPartyName.focus();
                return;
            }
            
            if (!partyCity) {
                showNotification("Please enter city", 'error');
                newPartyCity.focus();
                return;
            }
            
            if (!partyState) {
                showNotification("Please enter state", 'error');
                newPartyState.focus();
                return;
            }
            
            if (!partyAddress) {
                showNotification("Please enter address", 'error');
                newPartyAddress.focus();
                return;
            }
            
            if (!partyGstPan) {
                showNotification("Please enter GST/PAN number", 'error');
                newPartyGstPan.focus();
                return;
            }
            
            // Validate GST/PAN format
            if (!isValidGstPan(partyGstPan)) {
                showNotification("Please enter a valid GST or PAN number", 'error');
                newPartyGstPan.focus();
                return;
            }
            
            if (!isCloudStorageAvailable()) {
                showCloudOnlyError("Party creation");
                return;
            }
            
            try {
                console.log("ðŸ”„ Adding new party to cloud storage...");
                
                // Check if party already exists (by name or GST/PAN)
                const suppliersRef = collection(db, 'suppliers');
                const q1 = query(suppliersRef, where('name', '==', partyName));
                const q2 = query(suppliersRef, where('gstPan', '==', partyGstPan));
                
                const [nameSnapshot, gstSnapshot] = await Promise.all([
                    getDocs(q1),
                    getDocs(q2)
                ]);
                
                if (!nameSnapshot.empty) {
                    showNotification("Party with this name already exists", 'error');
                    return;
                }
                
                if (!gstSnapshot.empty) {
                    showNotification("Party with this GST/PAN number already exists", 'error');
                    return;
                }
                
                // Add new party to database
                const partyData = {
                    name: partyName,
                    city: partyCity,
                    state: partyState,
                    address: partyAddress,
                    gstPan: partyGstPan,
                    createdAt: new Date().toISOString(),
                    createdBy: userId || 'anonymous',
                    createdByRole: userRole || 'admin'
                };
                
                await addDoc(suppliersRef, partyData);
                console.log("âœ… New party added to cloud:", partyName);
                
                // Note: allSuppliers will be updated automatically by the onSnapshot listener
                // No need to manually push here to avoid duplicates
                
                // Update dropdowns
                populateSupplierDropdowns();
                
                // Update party list in admin view
                renderPartyList();
                
                // Clear form
                clearPartyFormFields();
                
                showNotification("âœ… Party added successfully!", 'success');
                
            } catch (error) {
                handleCloudError(error, "Party creation");
            }
        }

        // GST/PAN validation function
        function isValidGstPan(value) {
            const gstRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
            const panRegex = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
            
            return gstRegex.test(value) || panRegex.test(value);
        }

        // Clear party form fields
        function clearPartyFormFields() {
            newPartyName.value = '';
            newPartyCity.value = '';
            newPartyState.value = '';
            newPartyAddress.value = '';
            newPartyGstPan.value = '';
        }

        // Render party list in admin view
        function renderPartyList() {
            console.log("ðŸ”„ Rendering party list, allParties count:", allParties.length);
            console.log("ðŸ”„ allParties data:", allParties);
            console.log("ðŸ”„ allSuppliers count:", allSuppliers.length);
            console.log("ðŸ”„ allSuppliers data:", allSuppliers);
            partyList.innerHTML = '';
            
            if (allParties.length === 0) {
                console.log("âš ï¸ No parties found in allParties array");
                partyList.innerHTML = '<p class="text-gray-500 text-center">No parties found</p>';
                return;
            }
            
            // Sort parties by name
            const sortedParties = [...allParties].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedParties.forEach(party => {
                const partyItem = document.createElement('div');
                partyItem.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border mb-2';
                partyItem.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium text-gray-900">${party.name}</div>
                        <div class="text-sm text-gray-600">${party.city}, ${party.state}</div>
                        <div class="text-xs text-gray-500">GST: ${party.gstPan}</div>
                    </div>
                    <button onclick="deleteParty('${party.id || party.name}')" 
                            class="text-red-600 hover:text-red-800 text-sm font-medium px-3 py-1 rounded hover:bg-red-50 border border-red-200">
                        Delete
                    </button>
                `;
                partyList.appendChild(partyItem);
            });
        }

        // Delete party (Admin only)
        window.deleteParty = async function(partyName) {
            // Check if user is admin
            if (userRole !== 'admin') {
                showNotification("âŒ Only admin can delete parties", 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete the party "${partyName}"? This action cannot be undone.`)) {
                return;
            }
            
            // Check if party is being used in any gate passes (both local and database)
            const isPartyInUseLocally = allGatePasses.some(gatePass => 
                gatePass.purchasedFrom === partyName || 
                gatePass.supplier === partyName
            );
            
            if (isPartyInUseLocally) {
                showNotification("âŒ Cannot delete party that is being used in gate passes", 'error');
                return;
            }
            
            // Additional check: Query database directly to ensure no gate passes are using this party
            try {
                console.log("ðŸ” Checking database for gate passes using this party...");
                showNotification("ðŸ” Checking database for party usage...", 'info');
                
                const gatePassesRef = collection(db, 'gate_passes');
                const q = query(gatePassesRef, 
                    where('purchasedFrom', '==', partyName)
                );
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    showNotification(`âŒ Cannot delete party. Found ${querySnapshot.size} gate pass(es) using this party in database`, 'error');
                    return;
                }
                
                // Also check for 'supplier' field (for backward compatibility)
                const q2 = query(gatePassesRef, 
                    where('supplier', '==', partyName)
                );
                const querySnapshot2 = await getDocs(q2);
                
                if (!querySnapshot2.empty) {
                    showNotification(`âŒ Cannot delete party. Found ${querySnapshot2.size} gate pass(es) using this party as supplier in database`, 'error');
                    return;
                }
                
                // Check for outgoing gate passes using this party as "Sold To"
                const q3 = query(gatePassesRef, 
                    where('soldTo', '==', partyName)
                );
                const querySnapshot3 = await getDocs(q3);
                
                if (!querySnapshot3.empty) {
                    showNotification(`âŒ Cannot delete party. Found ${querySnapshot3.size} outgoing gate pass(es) using this party as "Sold To" in database`, 'error');
                    return;
                }
                
                console.log("âœ… No gate passes found using this party in database");
                
            } catch (error) {
                console.error("âŒ Error checking database for party usage:", error);
                showNotification("âŒ Error checking party usage in database. Deletion cancelled for safety.", 'error');
                return;
            }
            
            if (!isCloudStorageAvailable()) {
                showCloudOnlyError("Party deletion");
                return;
            }
            
            try {
                console.log("ðŸ”„ Deleting party from cloud storage...");
                
                // Find the party document in Firebase
                const suppliersRef = collection(db, 'suppliers');
                const q = query(suppliersRef, where('name', '==', partyName));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    await deleteDoc(doc.ref);
                    console.log("âœ… Party deleted from cloud:", partyName);
                } else {
                    console.log("âš ï¸ Party not found in cloud storage:", partyName);
                }
                
                // Remove from local arrays
                const index = allSuppliers.indexOf(partyName);
                if (index > -1) {
                    allSuppliers.splice(index, 1);
                    console.log("âœ… Party removed from allSuppliers array:", partyName);
                } else {
                    console.log("âš ï¸ Party not found in allSuppliers array:", partyName);
                }
                
                // Also remove from allParties array
                allParties = allParties.filter(p => p.name !== partyName);
                console.log("âœ… Party removed from allParties array:", partyName);
                
                // Update dropdowns
                populateSupplierDropdowns();
                
                // Update party list in admin view
                renderPartyList();
                
                // Update admin stats
                updateAdminStats();
                
                showNotification("âœ… Party deleted successfully!", 'success');
                
            } catch (error) {
                console.error("âŒ Error deleting party:", error);
                handleCloudError(error, "Party deletion");
            }
        };

        // Fuzzy matching function
        function fuzzyMatch(query, text) {
            if (query.length === 0) return true;
            if (query.length > text.length) return false;
            
            let queryIndex = 0;
            for (let i = 0; i < text.length && queryIndex < query.length; i++) {
                if (text[i] === query[queryIndex]) {
                    queryIndex++;
                }
            }
            return queryIndex === query.length;
        }

        // Highlight matching text in suggestions
        function highlightMatch(text, query) {
            if (!query) return text;
            
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="font-semibold text-blue-600 bg-blue-100 px-1 rounded">$1</span>');
        }

        // Note: Old supplier input event listeners removed - now using dropdown select

        // Show the edit modal with the selected gate pass's data
        function showEditModal(docId, gatePass) {
            // Use firebaseId if available, otherwise use the passed docId
            const actualDocId = gatePass.firebaseId || docId;
            editGatePassIdInput.value = actualDocId;
            editGatepassTypeSelect.value = gatePass.type;
            editItemSelectInput.value = gatePass.item;
            editSupplierSelect.value = gatePass.purchasedFrom;
            editTruckNumberInput.value = gatePass.truckNumber;
            editDateInput.value = gatePass.date;
            editPartyWeightInput.value = gatePass.partyWeight || '';
            editOwnWeightInput.value = gatePass.ownWeight;
            editRemarks.value = gatePass.remarks || '';
            
            // Toggle party weight field visibility based on type
            toggleEditPartyWeightField();
            
            editModal.style.display = 'flex';
        }
        
        // Note: Old edit modal supplier input event listeners removed - now using dropdown select

        // Hide the edit modal
        function hideEditModal() {
            editModal.style.display = 'none';
        }

        // Simplified and reliable save function
        let isSaving = false; // Flag to prevent multiple submissions
        
        async function addGatePass(event) {
            event.preventDefault();
            
            // Prevent multiple submissions
            if (isSaving) {
                console.log("Already saving, ignoring duplicate submission");
                return;
            }
            
            isSaving = true;
            
            console.log("=== SAVE GATE PASS STARTED ===");
            console.log("userAuthReady:", userAuthReady);
            console.log("db initialized:", !!db);
            console.log("currentUser:", currentUser);

            // Show loading state
            setSaveButtonLoading(true);
            showNotification("Saving gate pass...", 'info');

            // Get form data
            const type = gatepassTypeSelect.value;
            const item = document.getElementById('itemSelect').value;
            const purchasedFrom = supplierSelect.value;
            const truckNumber = document.getElementById('truckNumber').value;
            const date = document.getElementById('date').value;
            const partyWeight = type === 'Outgoing' ? null : parseFloat(document.getElementById('partyWeight').value);
            const ownWeight = parseFloat(document.getElementById('ownWeight').value);
            const remarks = document.getElementById('remarks').value.trim();

            console.log("Form data:", { type, item, purchasedFrom, truckNumber, date, partyWeight, ownWeight });

            // Cloud-only storage: Check if Firebase is available
            if (!isCloudStorageAvailable()) {
                showCloudOnlyError("Gate pass saving");
                setSaveButtonLoading(false);
                isSaving = false;
                return;
            }
            
            // Validate form data
            const validationErrors = validateGatePassData({ type, item, purchasedFrom, truckNumber, date, partyWeight, ownWeight });
            if (validationErrors.length > 0) {
                showNotification(`âŒ Validation failed: ${validationErrors.join(', ')}`, 'error');
                setSaveButtonLoading(false);
                isSaving = false;
                return;
            }

            // Generate auto-incrementing gate pass number
            const gatePassNumber = await generateGatePassNumber();
            
            const gatePassData = {
                id: gatePassNumber, // Use the formatted gate pass number
                gatePassNumber: gatePassNumber, // Store the formatted number separately
                type,
                item,
                purchasedFrom,
                truckNumber,
                date,
                partyWeight,
                ownWeight,
                remarks: remarks || '',
                userId: userId || 'anonymous',
                userRole: userRole || 'user',
                status: 'active',
                createdAt: new Date().toISOString(),
                savedToFirebase: true // Always true in cloud-only mode
            };

            // Save directly to Firebase (cloud-only)
            try {
                console.log("ðŸ”„ Saving gate pass to cloud storage...");
                
                // Save gate pass to Firebase
                const docRef = await addDoc(collection(db, 'gate_passes'), gatePassData);
                console.log("âœ… Gate pass saved to Firebase with ID:", docRef.id);
                
                // Update gate pass data with Firebase ID
                gatePassData.firebaseId = docRef.id;
                
                // Save supplier to Firebase if new
                const supplierExists = allSuppliers.some(s => s === purchasedFrom);
                if (!supplierExists) {
                    const supplierData = {
                        name: purchasedFrom,
                        createdAt: new Date().toISOString(),
                        createdBy: userId || 'anonymous'
                    };
                    const supplierRef = await addDoc(collection(db, 'suppliers'), supplierData);
                    console.log("âœ… New supplier saved to Firebase:", supplierRef.id);
                    // Note: allSuppliers will be updated automatically by the onSnapshot listener
                }
                
                // Update UI with cloud data
                const existingEntry = allGatePasses.find(item => item.id === gatePassData.id);
                if (!existingEntry) {
                    allGatePasses.push(gatePassData);
                    renderGatePasses(allGatePasses);
                    calculateAndRenderInventory(allGatePasses);
                }
                
                // Reset form
                addGatePassForm.reset();
                supplierSelect.value = '';
                document.getElementById('remarks').value = '';
                setSaveButtonLoading(false);
                
                showNotification("âœ… Gate pass saved to cloud successfully!", 'success');
                console.log("=== CLOUD SAVE COMPLETED SUCCESSFULLY ===");
                
                // Update sync status
                updateSyncStatus();
                
                // Reset the saving flag
                isSaving = false;
                
            } catch (error) {
                handleCloudError(error, "Gate pass saving");
                setSaveButtonLoading(false);
                isSaving = false;
            }
        }

        // Cloud-only data loading functions
        async function loadDataFromCloud() {
            if (!isCloudStorageAvailable()) {
                showCloudOnlyError("Data loading");
                return;
            }

            try {
                console.log("ðŸ”„ Loading data from cloud storage...");
                
                // Ensure we're authenticated
                if (!auth.currentUser) {
                    console.log("ðŸ”‘ Authenticating for data access...");
                    await signInAnonymously(auth);
                    console.log("âœ… Authentication successful");
                }
                
                // Load gate passes from Firebase
                const gatePassesSnapshot = await getDocs(collection(db, 'gate_passes'));
                allGatePasses.length = 0; // Clear existing data
                
                gatePassesSnapshot.forEach(doc => {
                    const data = doc.data();
                    data.firebaseId = doc.id;
                    allGatePasses.push(data);
                });
                
                console.log(`âœ… Loaded ${allGatePasses.length} gate passes from cloud`);
                
                // Render the table
                renderGatePassTable(allGatePasses);
                
                // Load suppliers from Firebase
                const suppliersSnapshot = await getDocs(collection(db, 'suppliers'));
                allSuppliers.length = 0; // Clear existing data
                
                suppliersSnapshot.forEach(doc => {
                    const data = doc.data();
                    allSuppliers.push(data.name);
                });
                
                console.log(`âœ… Loaded ${allSuppliers.length} suppliers from cloud`);
                
                // Update UI with cloud data
                renderGatePasses(allGatePasses);
                calculateAndRenderInventory(allGatePasses);
                
                // Update dropdowns
                populateSupplierDropdowns();
                
                showNotification("âœ… Data loaded from cloud successfully!", 'success');
                
            } catch (error) {
                handleCloudError(error, "Data loading");
            }
        }

        // Cloud-only sync status display
        function updateSyncStatus() {
            if (isCloudStorageAvailable()) {
                syncStatusText.textContent = "Cloud storage connected";
                manualSyncBtn.classList.add('hidden');
            } else {
                syncStatusText.textContent = "Cloud storage unavailable";
                manualSyncBtn.classList.remove('hidden');
            }
        }

        // Manual data refresh function (cloud-only)
        async function manualSync() {
            console.log("ðŸ”„ Manual data refresh requested...");
            manualSyncBtn.disabled = true;
            manualSyncBtn.textContent = "Refreshing...";
            
            try {
                await loadDataFromCloud();
                showNotification("Data refreshed from cloud successfully!", 'success');
                
            } catch (error) {
                console.error("Data refresh failed:", error);
                showNotification("Data refresh failed. Please check your connection.", 'error');
            } finally {
                manualSyncBtn.disabled = false;
                manualSyncBtn.textContent = "Refresh Data";
                updateSyncStatus();
            }
        }

        // Save edited gate pass to Firestore (Cloud-only)
        async function saveEdit(event) {
            event.preventDefault();
            
            // Cloud-only validation
            if (!isCloudStorageAvailable()) {
                showCloudOnlyError("Gate pass update");
                return;
            }

            const docId = editGatePassIdInput.value;
            const type = editGatepassTypeSelect.value;
            const item = editItemSelectInput.value;
            const purchasedFrom = editSupplierSelect.value;
            const truckNumber = editTruckNumberInput.value;
            const date = editDateInput.value;
            
            // Find the gate pass to get its data first
            const gatePass = allGatePasses.find(gp => gp.firebaseId === docId || gp.id === docId);
            if (!gatePass) {
                showNotification("âŒ Gate pass not found", 'error');
                return;
            }
            
            const partyWeight = type === 'Outgoing' ? 
                (gatePass.outgoingPartyWeight || null) : 
                parseFloat(editPartyWeightInput.value);
            const ownWeight = parseFloat(editOwnWeightInput.value);
            const remarks = editRemarks.value.trim();

            // Validate form data
            const validationErrors = validateGatePassData({ type, item, purchasedFrom, truckNumber, date, partyWeight, ownWeight });
            if (validationErrors.length > 0) {
                showNotification(`âŒ Validation failed: ${validationErrors.join(', ')}`, 'error');
                return;
            }

            try {
                console.log("ðŸ”„ Updating gate pass in cloud storage...");
                
                // Use the firebaseId for the update
                const firebaseId = gatePass.firebaseId || docId;
                
                // Check if the supplier is new and add it to the database
                const supplierExists = allSuppliers.some(s => s === purchasedFrom);
                if (!supplierExists) {
                    const supplierData = {
                        name: purchasedFrom,
                        createdAt: new Date().toISOString(),
                        createdBy: userId || 'anonymous'
                    };
                    await addDoc(collection(db, 'suppliers'), supplierData);
                    console.log("âœ… New supplier added to cloud:", purchasedFrom);
                    allSuppliers.push(purchasedFrom);
                }

                // Update gate pass in Firebase using firebaseId
                const gatePassRef = doc(db, 'gate_passes', firebaseId);
                const updateData = {
                    type,
                    item,
                    purchasedFrom,
                    truckNumber,
                    date,
                    ownWeight,
                    remarks: remarks || '',
                    updatedAt: new Date().toISOString(),
                    updatedBy: userId || 'anonymous'
                };

                // Only update partyWeight for incoming gate passes
                if (type === 'Incoming') {
                    updateData.partyWeight = partyWeight;
                }

                await updateDoc(gatePassRef, updateData);
                
                console.log("âœ… Gate pass updated in cloud:", docId);
                hideEditModal();
                if (editSupplierDropdownList) {
                    editSupplierDropdownList.classList.add('hidden');
                }
                
                // Refresh reports if we're in reports view
                const reportsView = document.getElementById('reportsView');
                if (reportsView && !reportsView.classList.contains('hidden')) {
                    // Check which tab is active and refresh accordingly
                    const outgoingContent = document.getElementById('outgoingReportsContent');
                    const incomingContent = document.getElementById('incomingReportsContent');
                    
                    if (outgoingContent && !outgoingContent.classList.contains('hidden')) {
                        loadOutgoingGatePasses();
                    } else if (incomingContent && !incomingContent.classList.contains('hidden')) {
                        loadIncomingGatePasses();
                    }
                }
                
                showNotification("âœ… Gate pass updated successfully!", 'success');
                
            } catch (error) {
                handleCloudError(error, "Gate pass update");
            }
        }

        // Delete gate pass from Firestore (Cloud-only)
        async function deleteGatePass(docId) {
            // Cloud-only validation
            if (!isCloudStorageAvailable()) {
                showCloudOnlyError("Gate pass deletion");
                return;
            }
            
            // Confirm deletion
            if (!confirm("Are you sure you want to delete this gate pass? This action cannot be undone.")) {
                return;
            }
            
            try {
                console.log("ðŸ”„ Deleting gate pass from cloud storage...");
                
                // Delete from Firebase
                await deleteDoc(doc(db, 'gate_passes', docId));
                console.log("âœ… Gate pass deleted from cloud:", docId);
                
                showNotification("âœ… Gate pass deleted successfully!", 'success');
                
            } catch (error) {
                handleCloudError(error, "Gate pass deletion");
            }
        }
        
        // Function to print a single gate pass
        function printGatePass(gatePass) {
            const date = new Date(gatePass.date + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            const printContent = `
                <div class="print-container" style="padding: 2rem; max-width: 600px; margin: auto; font-family: 'Inter', sans-serif;">
                    <h1 style="font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 1rem; color: #1f2937;">Gate Pass</h1>
                    <div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; background-color: #f9fafb;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <div>
                                <p style="font-size: 0.875rem; color: #6b7280;">Date</p>
                                <p style="font-weight: 500; color: #1f2937;">${formattedDate}</p>
                            </div>
                            <div>
                                <p style="font-size: 0.875rem; color: #6b7280;">Gate Pass ID</p>
                                <p style="font-weight: 500; color: #1f2937;">#${Math.random().toString(36).substr(2, 9).toUpperCase()}</p>
                            </div>
                        </div>
                        <div style="border-top: 1px dashed #d1d5db; padding-top: 1rem; margin-top: 1rem;">
                            <p style="font-size: 0.875rem; color: #6b7280;">${gatePass.type === 'Outgoing' ? 'Sold To' : 'Supplier'}</p>
                            <p style="font-size: 1.25rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem;">${gatePass.purchasedFrom}</p>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <p style="font-size: 0.875rem; color: #6b7280;">Type</p>
                                <p style="font-weight: 500; color: #1f2937;">${gatePass.type}</p>
                            </div>
                            <div>
                                <p style="font-size: 0.875rem; color: #6b7280;">Item</p>
                                <p style="font-weight: 500; color: #1f2937;">${gatePass.item}</p>
                            </div>
                            <div>
                                <p style="font-size: 0.875rem; color: #6b7280;">Truck Number</p>
                                <p style="font-weight: 500; color: #1f2937;">${gatePass.truckNumber}</p>
                            </div>
                            ${gatePass.type === 'Incoming' ? `
                            <div>
                                <p style="font-size: 0.875rem; color: #6b7280;">Party Weight</p>
                                <p style="font-weight: 500; color: #1f2937;">${gatePass.partyWeight} quintal</p>
                            </div>
                            ` : ''}
                            <div>
                                <p style="font-size: 0.875rem; color: #6b7280;">Own Weight</p>
                                <p style="font-weight: 500; color: #1f2937;">${gatePass.ownWeight} quintal</p>
                            </div>
                            ${gatePass.type === 'Outgoing' && gatePass.itemRate ? `
                            <div>
                                <p style="font-size: 0.875rem; color: #6b7280;">Rate per Quintal</p>
                                <p style="font-weight: 500; color: #1f2937;">â‚¹${gatePass.itemRate}</p>
                            </div>
                            <div>
                                <p style="font-size: 0.875rem; color: #6b7280;">Broker Name</p>
                                <p style="font-weight: 500; color: #1f2937;">${gatePass.brokerName}</p>
                            </div>
                            <div>
                                <p style="font-size: 0.875rem; color: #6b7280;">Party Weight</p>
                                <p style="font-weight: 500; color: #1f2937;">${gatePass.outgoingPartyWeight} quintal</p>
                            </div>
                            <div>
                                <p style="font-size: 0.875rem; color: #6b7280;">Payment Due</p>
                                <p style="font-weight: 500; color: #1f2937;">${gatePass.paymentDueDays} days (${gatePass.paymentDueDate || 'Calculating...'})</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: center; font-size: 0.75rem; color: #9ca3af;">
                        <p>Generated by Grain Procurement System</p>
                    </div>
                </div>
            `;
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // Toggles between the main view, reports view, and admin view
        function toggleView(view) {
            // Reset all views
            mainView.classList.add('hidden');
            reportsView.classList.add('hidden');
            adminView.classList.add('hidden');
            
            // Reset all buttons
            recordViewBtn.classList.remove('bg-blue-600', 'text-white');
            recordViewBtn.classList.add('bg-gray-200', 'text-gray-800');
            reportsViewBtn.classList.remove('bg-blue-600', 'text-white');
            reportsViewBtn.classList.add('bg-gray-200', 'text-gray-800');
            adminViewBtn.classList.remove('bg-blue-600', 'text-white');
            adminViewBtn.classList.add('bg-gray-200', 'text-gray-800');
            
            if (view === 'reports') {
                reportsView.classList.remove('hidden');
                reportsViewBtn.classList.add('bg-blue-600', 'text-white');
                reportsViewBtn.classList.remove('bg-gray-200', 'text-gray-800');
                
                // Set default to outgoing tab
                switchReportsTab('outgoing');
                
                // Refresh reports data when switching to reports view
                renderGatePassTable(allGatePasses);
                
                // Add a small delay to ensure data is loaded, then load outgoing gate passes
                setTimeout(() => {
                    console.log('ðŸ”„ Loading reports with delay, allGatePasses count:', allGatePasses.length);
                    loadOutgoingGatePasses();
                }, 100);
            } else if (view === 'admin') {
                adminView.classList.remove('hidden');
                adminViewBtn.classList.add('bg-blue-600', 'text-white');
                adminViewBtn.classList.remove('bg-gray-200', 'text-gray-800');
                updateAdminStats();
                renderPartyList();
                loadDuePayments();
                
                // Ensure we're on the payments tab by default
                switchAdminTab('payments');
            } else {
                mainView.classList.remove('hidden');
                recordViewBtn.classList.add('bg-blue-600', 'text-white');
                recordViewBtn.classList.remove('bg-gray-200', 'text-gray-800');
            }
        }

        function updateAdminStats() {
            const totalGatePasses = allGatePasses.length;
            const totalSuppliers = allSuppliers.length;
            
            // Update main stats (check if elements exist)
            const totalGatePassesEl = document.getElementById('totalGatePasses');
            const totalSuppliersEl = document.getElementById('totalSuppliers');
            const adminTotalGatePassesEl = document.getElementById('adminTotalGatePasses');
            const adminTotalSuppliersEl = document.getElementById('adminTotalSuppliers');
            const adminPendingPaymentsEl = document.getElementById('adminPendingPayments');
            const adminOverduePaymentsEl = document.getElementById('adminOverduePayments');
            
            if (totalGatePassesEl) totalGatePassesEl.textContent = totalGatePasses;
            if (totalSuppliersEl) totalSuppliersEl.textContent = totalSuppliers;
            if (adminTotalGatePassesEl) adminTotalGatePassesEl.textContent = totalGatePasses;
            if (adminTotalSuppliersEl) adminTotalSuppliersEl.textContent = totalSuppliers;
            
            // Calculate payment stats
            const outgoingPasses = allGatePasses.filter(gp => gp.type === 'Outgoing');
            let pendingAmount = 0;
            let overdueAmount = 0;
            
            outgoingPasses.forEach(gp => {
                if (gp.itemRate && gp.outgoingPartyWeight) {
                    const amount = gp.itemRate * gp.outgoingPartyWeight;
                    if (gp.paymentStatus === 'pending') {
                        pendingAmount += amount;
                    } else if (gp.paymentStatus === 'overdue') {
                        overdueAmount += amount;
                    }
                }
            });
            
            if (adminPendingPaymentsEl) adminPendingPaymentsEl.textContent = `â‚¹${pendingAmount.toLocaleString()}`;
            if (adminOverduePaymentsEl) adminOverduePaymentsEl.textContent = `â‚¹${overdueAmount.toLocaleString()}`;
            
            console.log("âœ… Admin stats updated");
        }

        // Admin tab switching function
        function switchAdminTab(tab) {
            const paymentsTab = document.getElementById('adminPaymentsTab');
            const partiesTab = document.getElementById('adminPartiesTab');
            const paymentsContent = document.getElementById('adminPaymentsContent');
            const partiesContent = document.getElementById('adminPartiesContent');
            
            if (tab === 'payments') {
                // Show payments tab
                paymentsTab.classList.add('bg-blue-600', 'text-white');
                paymentsTab.classList.remove('text-gray-600', 'hover:text-gray-800');
                partiesTab.classList.remove('bg-blue-600', 'text-white');
                partiesTab.classList.add('text-gray-600', 'hover:text-gray-800');
                
                paymentsContent.classList.remove('hidden');
                partiesContent.classList.add('hidden');
            } else if (tab === 'parties') {
                // Show parties tab
                partiesTab.classList.add('bg-blue-600', 'text-white');
                partiesTab.classList.remove('text-gray-600', 'hover:text-gray-800');
                paymentsTab.classList.remove('bg-blue-600', 'text-white');
                paymentsTab.classList.add('text-gray-600', 'hover:text-gray-800');
                
                partiesContent.classList.remove('hidden');
                paymentsContent.classList.add('hidden');
                
                // Ensure party list is rendered when switching to parties tab
                renderPartyList();
            } else if (tab === 'payments') {
                // Show payments tab
                paymentsTab.classList.add('bg-blue-600', 'text-white');
                paymentsTab.classList.remove('text-gray-600', 'hover:text-gray-800');
                partiesTab.classList.remove('bg-blue-600', 'text-white');
                partiesTab.classList.add('text-gray-600', 'hover:text-gray-800');
                
                paymentsContent.classList.remove('hidden');
                partiesContent.classList.add('hidden');
                
                // Ensure payments are loaded when switching to payments tab
                loadDuePayments();
            }
        }

        // Function to load due payments
        function loadDuePayments() {
            console.log("ðŸ”„ Loading due payments, allGatePasses count:", allGatePasses.length);
            console.log("ðŸ”„ allGatePasses data:", allGatePasses);
            
            // Use enhanced payment data loading
            loadEnhancedPaymentData();
            return;
            
            // Check if allGatePasses is empty
            if (allGatePasses.length === 0) {
                console.log("âš ï¸ No gate passes found in allGatePasses array");
                console.log("ðŸ”„ Attempting to reload data...");
                
                // Try to reload data
                loadGatePassesFromFirebase();
                
                // Show message in table
                const tbody = document.getElementById('duePaymentsTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            No gate passes found. Please create some outgoing gate passes first.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Check each gate pass individually
            allGatePasses.forEach((gp, index) => {
                console.log(`Gate Pass ${index}:`, {
                    id: gp.id,
                    type: gp.type,
                    itemRate: gp.itemRate,
                    ownWeight: gp.ownWeight,
                    paymentDueDate: gp.paymentDueDate,
                    brokerName: gp.brokerName,
                    paymentDueDays: gp.paymentDueDays
                });
            });
            
            const outgoingPasses = allGatePasses.filter(gp => 
                gp.type === 'Outgoing' && 
                gp.itemRate && 
                gp.ownWeight
            );
            
            console.log("ðŸ”„ All outgoing passes (before paymentDueDate filter):", outgoingPasses.length);
            
            // Calculate paymentDueDate for passes that don't have it
            const outgoingPassesWithDueDate = outgoingPasses.map(gp => {
                if (!gp.paymentDueDate) {
                    const gatePassDate = new Date(gp.date);
                    const dueDate = new Date(gatePassDate);
                    // Use paymentDueDays if available, otherwise default to 30 days
                    const dueDays = gp.paymentDueDays || 30;
                    dueDate.setDate(dueDate.getDate() + dueDays);
                    gp.paymentDueDate = dueDate.toISOString().split('T')[0];
                    console.log(`Calculated paymentDueDate for ${gp.id}: ${gp.paymentDueDate} (${dueDays} days from ${gp.date})`);
                }
                return gp;
            });
            
            console.log("ðŸ”„ Outgoing passes with paymentDueDate:", outgoingPassesWithDueDate.length);
            
            console.log("ðŸ”„ Outgoing passes details:", outgoingPassesWithDueDate);
            
            // Debug payment calculations
            outgoingPassesWithDueDate.forEach(gp => {
                console.log(`ðŸ” Payment debug for ${gp.id}:`, {
                    itemRate: gp.itemRate,
                    ownWeight: gp.ownWeight,
                    paymentHistory: gp.paymentHistory,
                    calculatedTotal: gp.itemRate * gp.outgoingPartyWeight
                });
            });
            
            // Calculate payment amounts and status
            const paymentsWithAmounts = outgoingPassesWithDueDate.map(gatePass => {
                const totalAmount = gatePass.itemRate * gatePass.outgoingPartyWeight;
                const dueDate = new Date(gatePass.paymentDueDate);
                const today = new Date();
                const daysOverdue = Math.max(0, Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24)));
                
                // Handle payment history and calculations
                const paymentHistory = gatePass.paymentHistory || [];
                const totalReceived = paymentHistory.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                const remainingAmount = totalAmount - totalReceived;
                
                // Determine current status
                let paymentStatus = 'pending';
                if (totalAmount > 0) {
                    if (totalReceived >= totalAmount) {
                        paymentStatus = 'received';
                    } else if (totalReceived > 0) {
                        paymentStatus = 'partial';
                    }
                }
                
                // Check if payment is overdue
                if (paymentStatus !== 'received' && daysOverdue > 0) {
                    paymentStatus = 'overdue';
                }
                
                return {
                    ...gatePass,
                    totalAmount,
                    amountReceived: totalReceived,
                    remainingAmount,
                    daysOverdue,
                    paymentStatus,
                    paymentHistory,
                    paymentReceivedDate: gatePass.paymentReceivedDate || null,
                    paymentNotes: gatePass.paymentNotes || ''
                };
            });
            
            // Apply filters
            const statusFilter = document.getElementById('paymentStatusFilter').value;
            const brokerFilter = document.getElementById('brokerFilter').value;
            const dateFilter = document.getElementById('dueDateFilter').value;
            
            let filteredPayments = paymentsWithAmounts;
            
            if (statusFilter === 'pending') {
                filteredPayments = paymentsWithAmounts.filter(p => p.paymentStatus === 'pending' && p.daysOverdue === 0);
            } else if (statusFilter === 'partial') {
                filteredPayments = paymentsWithAmounts.filter(p => p.paymentStatus === 'partial');
            } else if (statusFilter === 'overdue') {
                filteredPayments = paymentsWithAmounts.filter(p => p.paymentStatus !== 'received' && p.daysOverdue > 0);
            } else if (statusFilter === 'received') {
                filteredPayments = paymentsWithAmounts.filter(p => p.paymentStatus === 'received');
            }
            
            if (brokerFilter !== 'all') {
                filteredPayments = filteredPayments.filter(p => p.brokerName === brokerFilter);
            }
            
            if (dateFilter) {
                filteredPayments = filteredPayments.filter(p => p.paymentDueDate === dateFilter);
            }
            
            // Update summary cards
            if (typeof updatePaymentSummaryCards === 'function') {
                updatePaymentSummaryCards(paymentsWithAmounts);
            }
            
            // Update broker filter options
            if (typeof updateBrokerFilter === 'function') {
                updateBrokerFilter(paymentsWithAmounts);
            }
            
            // Render table
            if (typeof renderDuePaymentsTable === 'function') {
                renderDuePaymentsTable(filteredPayments);
            } else {
                console.log("âš ï¸ renderDuePaymentsTable function not available");
            }
        }

        // Helper functions for payment management
        function updatePaymentSummaryCards(payments) {
            const overdue = payments.filter(p => p.paymentStatus !== 'received' && p.daysOverdue > 0);
            const pending = payments.filter(p => p.paymentStatus === 'pending' && p.daysOverdue === 0);
            const partial = payments.filter(p => p.paymentStatus === 'partial');
            const received = payments.filter(p => p.paymentStatus === 'received');
            
            const overdueAmount = overdue.reduce((sum, p) => sum + p.remainingAmount, 0);
            const pendingAmount = pending.reduce((sum, p) => sum + p.remainingAmount, 0);
            const partialAmount = partial.reduce((sum, p) => sum + p.remainingAmount, 0);
            const receivedAmount = received.reduce((sum, p) => sum + p.totalAmount, 0);
            const totalAmount = payments.reduce((sum, p) => sum + p.totalAmount, 0);
            
            // Update elements only if they exist
            console.log("ðŸ” Checking for summary card elements...");
            
            const overdueAmountEl = document.getElementById('overdueAmount');
            const overdueCountEl = document.getElementById('overdueCount');
            const pendingAmountEl = document.getElementById('pendingAmount');
            const pendingCountEl = document.getElementById('pendingCount');
            const partialAmountEl = document.getElementById('partialAmount');
            const partialCountEl = document.getElementById('partialCount');
            const receivedAmountEl = document.getElementById('receivedAmount');
            const receivedCountEl = document.getElementById('receivedCount');
            const totalAmountEl = document.getElementById('totalAmount');
            const totalCountEl = document.getElementById('totalCount');
            
            console.log("ðŸ” Element availability:", {
                overdueAmount: !!overdueAmountEl,
                overdueCount: !!overdueCountEl,
                pendingAmount: !!pendingAmountEl,
                pendingCount: !!pendingCountEl,
                partialAmount: !!partialAmountEl,
                partialCount: !!partialCountEl,
                receivedAmount: !!receivedAmountEl,
                receivedCount: !!receivedCountEl,
                totalAmount: !!totalAmountEl,
                totalCount: !!totalCountEl
            });
            
            if (overdueAmountEl) overdueAmountEl.textContent = `â‚¹${overdueAmount.toLocaleString()}`;
            if (overdueCountEl) overdueCountEl.textContent = `${overdue.length} payments`;
            if (pendingAmountEl) pendingAmountEl.textContent = `â‚¹${pendingAmount.toLocaleString()}`;
            if (pendingCountEl) pendingCountEl.textContent = `${pending.length} payments`;
            if (partialAmountEl) partialAmountEl.textContent = `â‚¹${partialAmount.toLocaleString()}`;
            if (partialCountEl) partialCountEl.textContent = `${partial.length} payments`;
            if (receivedAmountEl) receivedAmountEl.textContent = `â‚¹${receivedAmount.toLocaleString()}`;
            if (receivedCountEl) receivedCountEl.textContent = `${received.length} payments`;
            if (totalAmountEl) totalAmountEl.textContent = `â‚¹${totalAmount.toLocaleString()}`;
            if (totalCountEl) totalCountEl.textContent = `${payments.length} payments`;
            
            console.log("âœ… Payment summary cards updated");
        }

        function updateBrokerFilter(payments) {
            const brokers = [...new Set(payments.map(p => p.brokerName).filter(Boolean))];
            const brokerSelect = document.getElementById('brokerFilter');
            
            if (!brokerSelect) {
                console.log("âš ï¸ Broker filter element not found");
                return;
            }
            
            // Clear existing options except "All Brokers"
            brokerSelect.innerHTML = '<option value="all">All Brokers</option>';
            
            brokers.forEach(broker => {
                const option = document.createElement('option');
                option.value = broker;
                option.textContent = broker;
                brokerSelect.appendChild(option);
            });
            
            console.log("âœ… Broker filter updated with", brokers.length, "brokers");
        }

        function renderDuePaymentsTable(payments) {
            console.log("ðŸ”„ Rendering payments table with", payments.length, "payments");
            console.log("ðŸ”„ Payments data:", payments);
            
            const tbody = document.getElementById('duePaymentsTableBody');
            if (!tbody) {
                console.log("âš ï¸ Due payments table body not found");
                return;
            }
            
            tbody.innerHTML = '';
            
            if (payments.length === 0) {
                console.log("âš ï¸ No payments to render");
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            No payments found matching the current filters.
                        </td>
                    </tr>
                `;
                return;
            }
            
            payments.forEach(payment => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusBadge = getPaymentStatusBadge(payment);
                const daysOverdueText = payment.daysOverdue > 0 ? `${payment.daysOverdue} days overdue` : 'On time';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${payment.id}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${payment.item}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${payment.purchasedFrom}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${payment.brokerName || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        â‚¹${payment.totalAmount.toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${payment.paymentDueDate}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${statusBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <button onclick="openPaymentModal('${payment.id}')" class="text-blue-600 hover:text-blue-800">
                            Manage
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function getPaymentStatusBadge(payment) {
            const status = payment.paymentStatus;
            const daysOverdue = payment.daysOverdue;
            
            if (status === 'received') {
                return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Received</span>';
            } else if (status === 'partial') {
                return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Partial</span>';
            } else if (daysOverdue > 0) {
                return `<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Overdue (${daysOverdue}d)</span>`;
            } else {
                return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Pending</span>';
            }
        }



        // Function to open payment modal for managing payments
        function openPaymentModal(gatePassId) {
            console.log("ðŸ”„ Opening payment modal for gate pass:", gatePassId);
            
            // Find the gate pass
            const gatePass = allGatePasses.find(gp => gp.id === gatePassId);
            if (!gatePass) {
                console.log("âš ï¸ Gate pass not found:", gatePassId);
                showNotification("Gate pass not found", 'error');
                return;
            }
            
            // Calculate payment details
            const totalAmount = gatePass.itemRate * gatePass.outgoingPartyWeight;
            const paymentHistory = gatePass.paymentHistory || [];
            const totalReceived = paymentHistory.reduce((sum, payment) => sum + (payment.amount || 0), 0);
            const remainingAmount = totalAmount - totalReceived;
            
            // Determine payment status
            let paymentStatus = 'pending';
            if (totalAmount > 0) {
                if (totalReceived >= totalAmount) {
                    paymentStatus = 'received';
                } else if (totalReceived > 0) {
                    paymentStatus = 'partial';
                }
            }
            
            console.log("ðŸ’° Payment calculation:", {
                gatePassId,
                totalAmount,
                totalReceived,
                remainingAmount,
                paymentStatus,
                paymentHistory
            });
            
            // Update modal fields (with null checks)
            const paymentGatePassIdEl = document.getElementById('paymentGatePassId');
            const paymentGatePassIdDisplayEl = document.getElementById('paymentGatePassIdDisplay');
            const paymentAmountDisplayEl = document.getElementById('paymentAmountDisplay');
            const paymentBrokerDisplayEl = document.getElementById('paymentBrokerDisplay');
            const paymentDueDateDisplayEl = document.getElementById('paymentDueDateDisplay');
            const paymentReceivedDateEl = document.getElementById('paymentReceivedDate');
            const amountReceivedEl = document.getElementById('amountReceived');
            const remainingAmountEl = document.getElementById('remainingAmount');
            const paymentStatusDisplayEl = document.getElementById('paymentStatusDisplay');
            const paymentNotesEl = document.getElementById('paymentNotes');
            
            if (paymentGatePassIdEl) paymentGatePassIdEl.value = gatePassId;
            if (paymentGatePassIdDisplayEl) paymentGatePassIdDisplayEl.value = gatePassId;
            if (paymentAmountDisplayEl) paymentAmountDisplayEl.value = `â‚¹${totalAmount.toLocaleString()}`;
            if (paymentBrokerDisplayEl) paymentBrokerDisplayEl.value = gatePass.brokerName || 'N/A';
            if (paymentDueDateDisplayEl) paymentDueDateDisplayEl.value = gatePass.paymentDueDate || 'N/A';
            if (paymentReceivedDateEl) paymentReceivedDateEl.value = '';
            if (amountReceivedEl) amountReceivedEl.value = '';
            if (remainingAmountEl) remainingAmountEl.value = `â‚¹${remainingAmount.toLocaleString()}`;
            if (paymentStatusDisplayEl) paymentStatusDisplayEl.value = paymentStatus.charAt(0).toUpperCase() + paymentStatus.slice(1);
            if (paymentNotesEl) paymentNotesEl.value = '';
            
            // Show modal
            const paymentModal = document.getElementById('paymentStatusModal');
            if (paymentModal) {
                paymentModal.style.display = 'flex';
            } else {
                console.log("âš ï¸ Payment modal not found");
                showNotification("Payment modal not available", 'error');
            }
        }

        // Make function globally accessible
        window.openPaymentModal = openPaymentModal;

        // Function to add sample payment data for testing
        function addSamplePaymentData() {
            console.log("ðŸ”„ Adding sample payment data...");
            
            // Find outgoing gate passes and add sample payment data
            const outgoingPasses = allGatePasses.filter(gp => gp.type === 'Outgoing' && gp.itemRate && gp.outgoingPartyWeight);
            
            if (outgoingPasses.length === 0) {
                console.log("âš ï¸ No outgoing gate passes found to add payment data");
                showNotification("No outgoing gate passes found. Create some outgoing gate passes first.", 'error');
                return;
            }
            
            // Add sample payment data to the first few outgoing gate passes
            outgoingPasses.slice(0, 3).forEach((gatePass, index) => {
                const totalAmount = gatePass.itemRate * gatePass.outgoingPartyWeight;
                
                // Add different payment scenarios
                if (index === 0) {
                    // Fully received payment
                    gatePass.paymentHistory = [
                        { amount: totalAmount, date: new Date().toISOString().split('T')[0], notes: 'Full payment received' }
                    ];
                    gatePass.paymentStatus = 'received';
                } else if (index === 1) {
                    // Partial payment
                    const partialAmount = Math.floor(totalAmount * 0.6);
                    gatePass.paymentHistory = [
                        { amount: partialAmount, date: new Date().toISOString().split('T')[0], notes: 'Partial payment received' }
                    ];
                    gatePass.paymentStatus = 'partial';
                } else if (index === 2) {
                    // Overdue payment
                    gatePass.paymentHistory = [];
                    gatePass.paymentStatus = 'overdue';
                    // Set due date to past
                    const pastDate = new Date();
                    pastDate.setDate(pastDate.getDate() - 10);
                    gatePass.paymentDueDate = pastDate.toISOString().split('T')[0];
                }
                
                console.log(`âœ… Added payment data for ${gatePass.id}:`, {
                    totalAmount,
                    paymentHistory: gatePass.paymentHistory,
                    paymentStatus: gatePass.paymentStatus
                });
            });
            
            // Reload payments to show the new data
            loadDuePayments();
            
            showNotification("Sample payment data added! Check the payments table.", 'success');
        }

        // Make function globally accessible
        window.addSamplePaymentData = addSamplePaymentData;

        // Function to remove duplicates from gate passes
        function removeDuplicateGatePasses() {
            const uniqueGatePasses = [];
            const seenIds = new Set();
            
            allGatePasses.forEach(gatePass => {
                if (!seenIds.has(gatePass.id)) {
                    uniqueGatePasses.push(gatePass);
                    seenIds.add(gatePass.id);
                }
            });
            
            if (uniqueGatePasses.length !== allGatePasses.length) {
                console.log(`Removed ${allGatePasses.length - uniqueGatePasses.length} duplicate gate passes`);
                allGatePasses.length = 0; // Clear array
                allGatePasses.push(...uniqueGatePasses); // Add unique entries
                renderGatePasses(allGatePasses);
                calculateAndRenderInventory(allGatePasses);
                showNotification("Duplicate entries removed", 'info');
            }
        }

        // Attach event listeners
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;
            
            const success = await login(username, password);
            if (success) {
                document.getElementById('usernameInput').value = '';
                document.getElementById('passwordInput').value = '';
            }
        });

        // Clear errors when user starts typing
        document.getElementById('usernameInput').addEventListener('input', clearLoginErrors);
        document.getElementById('passwordInput').addEventListener('input', clearLoginErrors);

        // Enhanced date picker functionality
        function setupDatePicker() {
            const dateInput = document.getElementById('date');
            const editDateInput = document.getElementById('editDate');
            const datePickerBtn = document.getElementById('datePickerBtn');
            const editDatePickerBtn = document.getElementById('editDatePickerBtn');
            
            console.log('Setting up date picker...');
            console.log('Date input found:', !!dateInput);
            console.log('Date picker button found:', !!datePickerBtn);
            console.log('Edit date input found:', !!editDateInput);
            console.log('Edit date picker button found:', !!editDatePickerBtn);
            
            // Function to get current date in YYYY-MM-DD format
            function getCurrentDate() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // Function to open date picker and set today's date if empty
            function openDatePicker(input) {
                // If input is empty, set today's date
                if (!input.value) {
                    input.value = getCurrentDate();
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                }
                
                // Focus the input first
                input.focus();
                
                // Try multiple methods to open the date picker
                setTimeout(() => {
                    // Method 1: Try showPicker() if available
                    if (input.showPicker) {
                        try {
                            input.showPicker();
                            return;
                        } catch (e) {
                            console.log('showPicker not supported');
                        }
                    }
                    
                    // Method 2: Create and dispatch a mouse event
                    const mouseEvent = new MouseEvent('mousedown', {
                        view: window,
                        bubbles: true,
                        cancelable: true
                    });
                    input.dispatchEvent(mouseEvent);
                    
                    // Method 3: Trigger focus and click
                    input.focus();
                    input.click();
                }, 10);
            }
            
            // Main form date picker button
            if (datePickerBtn && dateInput) {
                datePickerBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Date picker button clicked');
                    
                    // If input is empty, set today's date
                    if (!dateInput.value) {
                        dateInput.value = getCurrentDate();
                        dateInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    
                    // Focus the input first
                    dateInput.focus();
                    
                    // Use a small delay to ensure focus is set
                    setTimeout(() => {
                        // Try to trigger the date picker
                        if (dateInput.showPicker) {
                            try {
                                dateInput.showPicker();
                            } catch (err) {
                                console.log('showPicker failed, trying click');
                                dateInput.click();
                            }
                        } else {
                            // Fallback: trigger click event
                            dateInput.click();
                        }
                    }, 50);
                });
                
                // Also add mousedown event as backup
                datePickerBtn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    console.log('Date picker button mousedown');
                });
                
                console.log('Date picker button event listener added');
            } else {
                console.error('Date picker button or input not found');
            }
            
            // Edit modal date picker button
            if (editDatePickerBtn && editDateInput) {
                editDatePickerBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Edit date picker button clicked');
                    
                    // If input is empty, set today's date
                    if (!editDateInput.value) {
                        editDateInput.value = getCurrentDate();
                        editDateInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    
                    // Focus the input first
                    editDateInput.focus();
                    
                    // Use a small delay to ensure focus is set
                    setTimeout(() => {
                        // Try to trigger the date picker
                        if (editDateInput.showPicker) {
                            try {
                                editDateInput.showPicker();
                            } catch (err) {
                                console.log('Edit showPicker failed, trying click');
                                editDateInput.click();
                            }
                        } else {
                            // Fallback: trigger click event
                            editDateInput.click();
                        }
                    }, 50);
                });
                
                // Also add mousedown event as backup
                editDatePickerBtn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    console.log('Edit date picker button mousedown');
                });
                
                console.log('Edit date picker button event listener added');
            } else {
                console.error('Edit date picker button or input not found');
            }
            
            // Auto-populate only when user clicks on the input field (not on focus)
            dateInput.addEventListener('click', () => {
                if (!dateInput.value) {
                    dateInput.value = getCurrentDate();
                    dateInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            
            editDateInput.addEventListener('click', () => {
                if (!editDateInput.value) {
                    editDateInput.value = getCurrentDate();
                    editDateInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
        }
        
        logoutBtn.addEventListener('click', logout);
        addGatePassForm.addEventListener('submit', addGatePass);
        editForm.addEventListener('submit', saveEdit);
        cancelEditButton.addEventListener('click', hideEditModal);
        closeNotification.addEventListener('click', hideNotification);
        manualSyncBtn.addEventListener('click', manualSync);
        recordViewBtn.addEventListener('click', () => toggleView('record'));
        reportsViewBtn.addEventListener('click', () => toggleView('reports'));
        adminViewBtn.addEventListener('click', () => toggleView('admin'));
        
        // Admin tab switching
        document.getElementById('adminPaymentsTab').addEventListener('click', () => {
            switchAdminTab('payments');
        });
        
        document.getElementById('adminPartiesTab').addEventListener('click', () => {
            switchAdminTab('parties');
        });
        
        // Party management event listeners
        addPartyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            addNewParty();
        });
        
        clearPartyForm.addEventListener('click', clearPartyFormFields);
        
        
        
        // Enter key support for form fields
        [newPartyName, newPartyCity, newPartyState, newPartyAddress, newPartyGstPan].forEach(field => {
            field.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addNewParty();
                }
            });
        });
        
        
        // Make allGatePasses globally accessible
        window.allGatePasses = allGatePasses;
        
        // Initialize app
        window.onload = () => {
            showLoginModal();
            // Initialize date picker functionality after DOM is loaded
            setupDatePicker();
            // Initialize network monitoring
            initializeNetworkMonitoring();
            // Clean up any existing duplicates on app load
            setTimeout(() => {
                removeDuplicateGatePasses();
            }, 2000);
            
            // Add event listeners for gate pass type changes
            gatepassTypeSelect.addEventListener('change', function() {
                togglePartyWeightField();
            });
            
            editGatepassTypeSelect.addEventListener('change', function() {
                toggleEditPartyWeightField();
            });

            // Reports Tab Switching Functions
            window.switchReportsTab = function(tab) {
                const outgoingTab = document.getElementById('outgoingReportsTab');
                const incomingTab = document.getElementById('incomingReportsTab');
                const outgoingContent = document.getElementById('outgoingReportsContent');
                const incomingContent = document.getElementById('incomingReportsContent');
                
                if (tab === 'outgoing') {
                    // Update tab buttons
                    outgoingTab.classList.add('bg-blue-600', 'text-white');
                    outgoingTab.classList.remove('text-gray-600', 'hover:text-gray-800');
                    incomingTab.classList.remove('bg-blue-600', 'text-white');
                    incomingTab.classList.add('text-gray-600', 'hover:text-gray-800');
                    
                    // Show/hide content
                    outgoingContent.classList.remove('hidden');
                    incomingContent.classList.add('hidden');
                    
                    // Load outgoing data
                    loadOutgoingGatePasses();
                } else if (tab === 'incoming') {
                    // Update tab buttons
                    incomingTab.classList.add('bg-blue-600', 'text-white');
                    incomingTab.classList.remove('text-gray-600', 'hover:text-gray-800');
                    outgoingTab.classList.remove('bg-blue-600', 'text-white');
                    outgoingTab.classList.add('text-gray-600', 'hover:text-gray-800');
                    
                    // Show/hide content
                    incomingContent.classList.remove('hidden');
                    outgoingContent.classList.add('hidden');
                    
                    // Load incoming data
                    loadIncomingGatePasses();
                }
            };

            // Incoming Details Management Functions
            window.loadIncomingGatePasses = function() {
                // If no gate passes loaded, try to load them first
                if (allGatePasses.length === 0) {
                    console.log('âš ï¸ No gate passes loaded, attempting to load data...');
                    // Try to trigger data loading
                    if (typeof startRealtimeListeners === 'function') {
                        startRealtimeListeners();
                    }
                    // Wait a bit and try again
                    setTimeout(() => {
                        loadIncomingGatePasses();
                    }, 500);
                    return;
                }
                
                const incomingPasses = allGatePasses.filter(gp => gp.type === 'Incoming');
                const container = document.getElementById('incomingGatePassList');
                const filter = document.getElementById('incomingFilter').value;
                const filterStatus = document.getElementById('incomingFilterStatus');
                
                console.log('ðŸ” Loading incoming gate passes:', {
                    totalGatePasses: allGatePasses.length,
                    incomingPasses: incomingPasses.length,
                    filter: filter
                });
                
                let filteredPasses = incomingPasses;
                let statusText = '';
                let statusClass = '';
                
                if (filter === 'incomplete') {
                    filteredPasses = incomingPasses.filter(gp => !isIncomingDetailsComplete(gp));
                    console.log('ðŸ“‹ Incomplete incoming filter results:', {
                        totalIncoming: incomingPasses.length,
                        incomplete: filteredPasses.length,
                        incompletePasses: filteredPasses.map(gp => ({
                            id: gp.id,
                            item: gp.item,
                            hasItemRate: !!gp.itemRate,
                            hasBrokerName: !!gp.brokerName,
                            hasPaymentDueDays: !!gp.paymentDueDays
                        }))
                    });
                    statusText = `ðŸ“‹ Showing ${filteredPasses.length} incomplete incoming gate passes`;
                    statusClass = 'bg-yellow-100 text-yellow-800';
                } else if (filter === 'complete') {
                    filteredPasses = incomingPasses.filter(gp => isIncomingDetailsComplete(gp));
                    statusText = `âœ… Showing ${filteredPasses.length} complete incoming gate passes`;
                    statusClass = 'bg-green-100 text-green-800';
                } else {
                    statusText = `ðŸ“Š Showing all ${filteredPasses.length} incoming gate passes`;
                    statusClass = 'bg-blue-100 text-blue-800';
                }
                
                // Update filter status
                filterStatus.innerHTML = `<span class="px-2 py-1 ${statusClass} rounded-full text-xs font-medium">${statusText}</span>`;
                
                container.innerHTML = '';
                
                if (filteredPasses.length === 0) {
                    const noResultsMessage = filter === 'incomplete' ? 
                        'ðŸŽ‰ All incoming gate passes have complete details!' : 
                        'No incoming gate passes found.';
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">ðŸ“‹</div>
                            <p class="text-lg">${noResultsMessage}</p>
                        </div>
                    `;
                    return;
                }
                
                // Render incoming gate passes
                filteredPasses.forEach(gatePass => {
                    const isComplete = isIncomingDetailsComplete(gatePass);
                    const statusBadge = isComplete ? 
                        '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">Complete</span>' :
                        '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">Incomplete</span>';
                    
                    const gatePassCard = document.createElement('div');
                    gatePassCard.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow';
                    gatePassCard.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-800">Gate Pass #${gatePass.id}</h4>
                                <p class="text-sm text-gray-600">${gatePass.item} - ${gatePass.supplier || gatePass.party}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                ${statusBadge}
                                <button onclick="editIncomingDetails('${gatePass.id}')" 
                                        class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors">
                                    ${isComplete ? 'Edit' : 'Complete'}
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <span class="text-gray-500">Truck:</span>
                                <span class="font-medium">${gatePass.truckNumber}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Date:</span>
                                <span class="font-medium">${gatePass.date}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Party Weight:</span>
                                <span class="font-medium">${gatePass.partyWeight || 'N/A'} q</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Own Weight:</span>
                                <span class="font-medium">${gatePass.ownWeight || 'N/A'} q</span>
                            </div>
                        </div>
                        ${gatePass.remarks ? `<div class="mt-2 text-sm text-gray-600"><span class="font-medium">Remarks:</span> ${gatePass.remarks}</div>` : ''}
                    `;
                    container.appendChild(gatePassCard);
                });
            }

            // Function to check if incoming details are complete
            window.isIncomingDetailsComplete = function(gatePass) {
                return gatePass && 
                       gatePass.itemRate && 
                       gatePass.brokerName && 
                       gatePass.paymentDueDays;
            };

            // Function to edit gate pass from table
            window.editGatePassFromTable = function(gatePassId) {
                const gatePassIndex = allGatePasses.findIndex(gp => gp.id === gatePassId);
                if (gatePassIndex === -1) {
                    showNotification('Gate pass not found', 'error');
                    return;
                }
                
                const gatePass = allGatePasses[gatePassIndex];
                
                // Populate edit modal with current values
                document.getElementById('editGatePassId').value = gatePass.firebaseId || gatePass.id;
                document.getElementById('editGatepassTypeSelect').value = gatePass.type;
                document.getElementById('editItemSelect').value = gatePass.item;
                document.getElementById('editTruckNumber').value = gatePass.truckNumber;
                document.getElementById('editDate').value = gatePass.date;
                document.getElementById('editPartyWeight').value = gatePass.partyWeight || gatePass.outgoingPartyWeight || '';
                document.getElementById('editOwnWeight').value = gatePass.ownWeight || '';
                document.getElementById('editRemarks').value = gatePass.remarks || '';
                
                // Populate supplier dropdown
                const supplierSelect = document.getElementById('editSupplierSelect');
                supplierSelect.innerHTML = '<option value="">Select a party...</option>';
                allParties.forEach(party => {
                    const option = document.createElement('option');
                    option.value = party.name;
                    option.textContent = party.name;
                    if (party.name === (gatePass.supplier || gatePass.party || gatePass.purchasedFrom)) {
                        option.selected = true;
                    }
                    supplierSelect.appendChild(option);
                });
                
                // Show edit modal
                document.getElementById('editModal').style.display = 'flex';
            };

            // Function to edit incoming details
            window.editIncomingDetails = function(gatePassId) {
                const gatePassIndex = allGatePasses.findIndex(gp => gp.id === gatePassId);
                if (gatePassIndex === -1) {
                    showNotification('Gate pass not found', 'error');
                    return;
                }
                
                const gatePass = allGatePasses[gatePassIndex];
                
                // Populate modal fields
                document.getElementById('incomingGatePassId').value = gatePass.id;
                document.getElementById('incomingItem').value = gatePass.item;
                document.getElementById('incomingPurchasedFrom').value = gatePass.supplier || gatePass.party;
                document.getElementById('incomingTruckNumber').value = gatePass.truckNumber;
                document.getElementById('incomingPartyWeight').value = gatePass.partyWeight || '';
                document.getElementById('incomingOwnWeight').value = gatePass.ownWeight || '';
                document.getElementById('incomingDate').value = gatePass.date;
                document.getElementById('incomingItemRate').value = gatePass.itemRate || '';
                document.getElementById('incomingBrokerName').value = gatePass.brokerName || '';
                document.getElementById('incomingPaymentDueDays').value = gatePass.paymentDueDays || '';
                document.getElementById('incomingRemarks').value = gatePass.remarks || '';
                
                // Show modal
                document.getElementById('incomingDetailsModal').style.display = 'flex';
            }

            // Function to save incoming details
            window.saveIncomingDetails = function() {
                const gatePassId = document.getElementById('incomingGatePassId').value;
                const gatePassIndex = allGatePasses.findIndex(gp => gp.id === gatePassId);
                
                if (gatePassIndex === -1) {
                    showNotification('Gate pass not found', 'error');
                    return;
                }
                
                const gatePass = allGatePasses[gatePassIndex];
                
                // Update gate pass with new details
                gatePass.itemRate = parseFloat(document.getElementById('incomingItemRate').value);
                gatePass.brokerName = document.getElementById('incomingBrokerName').value;
                gatePass.paymentDueDays = parseInt(document.getElementById('incomingPaymentDueDays').value);
                gatePass.remarks = document.getElementById('incomingRemarks').value;
                gatePass.lastUpdatedBy = currentUser?.email || 'Unknown';
                gatePass.lastUpdatedAt = new Date().toISOString();
                
                // Calculate payment due date
                if (gatePass.paymentDueDays && gatePass.date) {
                    const dueDate = new Date(gatePass.date);
                    dueDate.setDate(dueDate.getDate() + gatePass.paymentDueDays);
                    gatePass.paymentDueDate = dueDate.toISOString().split('T')[0];
                }
                
                // Update in Firebase
                updateGatePassInFirebase(gatePass);
                
                // Refresh displays
                loadIncomingGatePasses();
                renderGatePasses(allGatePasses);
                renderGatePassTable(allGatePasses);
                
                // Close modal
                document.getElementById('incomingDetailsModal').style.display = 'none';
                
                showNotification('Incoming details saved successfully', 'success');
            };


            // Outgoing Details Management Functions
            window.loadOutgoingGatePasses = function() {
                // If no gate passes loaded, try to load them first
                if (allGatePasses.length === 0) {
                    console.log('âš ï¸ No gate passes loaded, attempting to load data...');
                    // Try to trigger data loading
                    if (typeof startRealtimeListeners === 'function') {
                        startRealtimeListeners();
                    }
                    // Wait a bit and try again
                    setTimeout(() => {
                        loadOutgoingGatePasses();
                    }, 500);
                    return;
                }
                
                const outgoingPasses = allGatePasses.filter(gp => gp.type === 'Outgoing');
                const container = document.getElementById('outgoingGatePassList');
                const filter = document.getElementById('outgoingFilter').value;
                const filterStatus = document.getElementById('outgoingFilterStatus');
                
                console.log('ðŸ” Loading outgoing gate passes:', {
                    totalGatePasses: allGatePasses.length,
                    outgoingPasses: outgoingPasses.length,
                    filter: filter
                });
                
                let filteredPasses = outgoingPasses;
                let statusText = '';
                let statusClass = '';
                
                if (filter === 'incomplete') {
                    filteredPasses = outgoingPasses.filter(gp => !isOutgoingDetailsComplete(gp));
                    console.log('ðŸ“‹ Incomplete filter results:', {
                        totalOutgoing: outgoingPasses.length,
                        incomplete: filteredPasses.length,
                        incompletePasses: filteredPasses.map(gp => ({
                            id: gp.id,
                            item: gp.item,
                            hasItemRate: !!gp.itemRate,
                            hasBrokerName: !!gp.brokerName,
                            hasPaymentDueDays: !!gp.paymentDueDays
                        }))
                    });
                    statusText = `ðŸ“‹ Showing ${filteredPasses.length} incomplete gate passes`;
                    statusClass = 'bg-yellow-100 text-yellow-800';
                } else if (filter === 'complete') {
                    filteredPasses = outgoingPasses.filter(gp => isOutgoingDetailsComplete(gp));
                    statusText = `âœ… Showing ${filteredPasses.length} complete gate passes`;
                    statusClass = 'bg-green-100 text-green-800';
                } else {
                    statusText = `ðŸ“Š Showing all ${filteredPasses.length} outgoing gate passes`;
                    statusClass = 'bg-blue-100 text-blue-800';
                }
                
                // Update filter status
                filterStatus.innerHTML = `<span class="px-2 py-1 ${statusClass} rounded-full text-xs font-medium">${statusText}</span>`;
                
                container.innerHTML = '';
                
                if (filteredPasses.length === 0) {
                    const noResultsMessage = filter === 'incomplete' ? 
                        'ðŸŽ‰ Great! All outgoing gate passes have complete details.' :
                        filter === 'complete' ? 
                        'No complete gate passes found. Add details to outgoing gate passes.' :
                        'No outgoing gate passes found.';
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">${noResultsMessage}</p>`;
                    return;
                }
                
                filteredPasses.forEach(gatePass => {
                    const listItem = document.createElement('div');
                    listItem.className = 'bg-gray-50 p-4 rounded-lg border';
                    
                    const hasDetails = isOutgoingDetailsComplete(gatePass);
                    const statusBadge = hasDetails ? 
                        '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Complete</span>' :
                        '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">Incomplete</span>';
                    
                    listItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <h4 class="font-semibold">${gatePass.item} - ${gatePass.type === 'Outgoing' ? 'Sold To: ' + gatePass.purchasedFrom : gatePass.purchasedFrom}</h4>
                                    ${statusBadge}
                                </div>
                                <p class="text-sm text-gray-600">Truck: ${gatePass.truckNumber} | Date: ${gatePass.date}</p>
                                <p class="text-sm text-gray-600">Own Weight: ${gatePass.ownWeight} quintal</p>
                                ${gatePass.outgoingPartyWeight ? `<p class="text-sm text-gray-600">Party Weight: ${gatePass.outgoingPartyWeight} quintal</p>` : ''}
                                ${hasDetails ? `
                                    <div class="mt-2 text-xs text-gray-500">
                                        Rate: â‚¹${gatePass.itemRate}/quintal | Broker: ${gatePass.brokerName} | Due: ${gatePass.paymentDueDays} days (${gatePass.paymentDueDate || 'Calculating...'})
                                    </div>
                                ` : ''}
                            </div>
                            <button onclick="editOutgoingDetails('${gatePass.id}')" 
                                    class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                ${hasDetails ? 'Edit Details' : 'Add Details'}
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(listItem);
                });
            };

            // Make isOutgoingDetailsComplete globally accessible
            window.isOutgoingDetailsComplete = function(gatePass) {
                return gatePass && 
                       gatePass.itemRate && 
                       gatePass.brokerName && 
                       gatePass.paymentDueDays &&
                       (gatePass.outgoingPartyWeight !== null && gatePass.outgoingPartyWeight !== undefined && gatePass.outgoingPartyWeight > 0);
            }

            // Make editOutgoingDetails globally accessible
            window.editOutgoingDetails = function(gatePassId) {
                // Access allGatePasses from the local scope
                const gatePass = allGatePasses.find(gp => gp.id === gatePassId);
                if (!gatePass) {
                    console.error('Gate pass not found:', gatePassId);
                    return;
                }
                
                // Populate the modal
                document.getElementById('outgoingGatePassId').value = gatePass.id;
                document.getElementById('outgoingItem').value = gatePass.item;
                document.getElementById('outgoingSoldTo').value = gatePass.purchasedFrom; // This is the buyer for outgoing
                document.getElementById('outgoingTruckNumber').value = gatePass.truckNumber;
                document.getElementById('outgoingOwnWeight').value = gatePass.ownWeight + ' quintal';
                document.getElementById('outgoingDate').value = gatePass.date;
                document.getElementById('outgoingItemRate').value = gatePass.itemRate || '';
                document.getElementById('outgoingBrokerName').value = gatePass.brokerName || '';
                document.getElementById('outgoingPartyWeight').value = gatePass.outgoingPartyWeight || '';
                document.getElementById('outgoingPaymentDueDays').value = gatePass.paymentDueDays || '';
                
                // If we have paymentDueDays but no calculated date, calculate it
                if (gatePass.paymentDueDays && !gatePass.paymentDueDate) {
                    const gatePassDate = new Date(gatePass.date);
                    const dueDate = new Date(gatePassDate);
                    dueDate.setDate(dueDate.getDate() + gatePass.paymentDueDays);
                    gatePass.paymentDueDate = dueDate.toISOString().split('T')[0];
                }
                
                // Show modal
                document.getElementById('outgoingDetailsModal').style.display = 'flex';
            }

            // Function to update gate pass in Firebase
            async function updateGatePassInFirebase(gatePass) {
                try {
                    if (gatePass.firebaseId && db) {
                        const gatePassRef = doc(db, 'gate_passes', gatePass.firebaseId);
                        
                        // Build update object with only defined values
                        const updateData = {
                            lastUpdatedBy: gatePass.lastUpdatedBy,
                            lastUpdatedAt: gatePass.lastUpdatedAt
                        };
                        
                        // Only add fields that have valid values
                        if (gatePass.itemRate !== undefined && gatePass.itemRate !== null) {
                            updateData.itemRate = gatePass.itemRate;
                        }
                        if (gatePass.brokerName !== undefined && gatePass.brokerName !== null) {
                            updateData.brokerName = gatePass.brokerName;
                        }
                        if (gatePass.outgoingPartyWeight !== undefined && gatePass.outgoingPartyWeight !== null) {
                            updateData.outgoingPartyWeight = gatePass.outgoingPartyWeight;
                        }
                        if (gatePass.paymentDueDays !== undefined && gatePass.paymentDueDays !== null) {
                            updateData.paymentDueDays = gatePass.paymentDueDays;
                        }
                        if (gatePass.paymentDueDate !== undefined && gatePass.paymentDueDate !== null) {
                            updateData.paymentDueDate = gatePass.paymentDueDate;
                        }
                        if (gatePass.remarks !== undefined && gatePass.remarks !== null) {
                            updateData.remarks = gatePass.remarks;
                        }
                        
                        await updateDoc(gatePassRef, updateData);
                        console.log('âœ… Gate pass updated in Firebase');
                    }
                } catch (error) {
                    console.error('âŒ Error updating gate pass in Firebase:', error);
                }
            }

            // Make saveOutgoingDetails globally accessible
            window.saveOutgoingDetails = async function() {
                console.log('saveOutgoingDetails called');
                const gatePassId = document.getElementById('outgoingGatePassId').value;
                const itemRate = parseFloat(document.getElementById('outgoingItemRate').value);
                const brokerName = document.getElementById('outgoingBrokerName').value.trim();
                const outgoingPartyWeight = parseFloat(document.getElementById('outgoingPartyWeight').value);
                const paymentDueDays = parseInt(document.getElementById('outgoingPaymentDueDays').value);
                
                console.log('Form data:', { gatePassId, itemRate, brokerName, outgoingPartyWeight, paymentDueDays });
                
                // Validation
                if (!itemRate || itemRate <= 0) {
                    showNotification('Please enter a valid item rate', 'error');
                    return;
                }
                if (!brokerName) {
                    showNotification('Please enter broker name', 'error');
                    return;
                }
                if (!outgoingPartyWeight || outgoingPartyWeight <= 0) {
                    showNotification('Please enter valid party weight', 'error');
                    return;
                }
                if (!paymentDueDays || paymentDueDays < 1 || paymentDueDays > 365) {
                    showNotification('Please enter valid payment due days (1-365)', 'error');
                    return;
                }
                
                // Find and update the gate pass
                const gatePassIndex = allGatePasses.findIndex(gp => gp.id === gatePassId);
                if (gatePassIndex !== -1) {
                    allGatePasses[gatePassIndex].itemRate = itemRate;
                    allGatePasses[gatePassIndex].brokerName = brokerName;
                    allGatePasses[gatePassIndex].outgoingPartyWeight = outgoingPartyWeight;
                    allGatePasses[gatePassIndex].paymentDueDays = paymentDueDays;
                    
                    // Calculate and store the actual due date
                    const gatePassDate = new Date(allGatePasses[gatePassIndex].date);
                    const dueDate = new Date(gatePassDate);
                    dueDate.setDate(dueDate.getDate() + paymentDueDays);
                    allGatePasses[gatePassIndex].paymentDueDate = dueDate.toISOString().split('T')[0];
                    allGatePasses[gatePassIndex].lastUpdatedBy = currentUser.name;
                    allGatePasses[gatePassIndex].lastUpdatedAt = new Date().toISOString();
                    
                    // Update in Firebase
                    await updateGatePassInFirebase(allGatePasses[gatePassIndex]);
                    
                    // Refresh displays immediately after local update
                    loadOutgoingGatePasses();
                    renderGatePasses(allGatePasses);
                    renderGatePassTable(allGatePasses);
                    
                    // Close modal
                    document.getElementById('outgoingDetailsModal').style.display = 'none';
                    
                    showNotification('Outgoing details saved successfully', 'success');
                }
            };

            // Event listeners for reports tab switching
            document.getElementById('outgoingReportsTab').addEventListener('click', () => {
                switchReportsTab('outgoing');
            });
            document.getElementById('incomingReportsTab').addEventListener('click', () => {
                switchReportsTab('incoming');
            });

            // Event listeners for outgoing details
            document.getElementById('outgoingFilter').addEventListener('change', loadOutgoingGatePasses);
            document.getElementById('refreshOutgoingReportsBtn').addEventListener('click', () => {
                console.log('ðŸ”„ Manual refresh triggered for outgoing');
                loadOutgoingGatePasses();
            });
            
            document.getElementById('outgoingDetailsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                window.saveOutgoingDetails();
            });
            document.getElementById('cancelOutgoingDetails').addEventListener('click', function() {
                document.getElementById('outgoingDetailsModal').style.display = 'none';
            });

            // Event listeners for incoming details
            document.getElementById('incomingFilter').addEventListener('change', loadIncomingGatePasses);
            document.getElementById('refreshIncomingReportsBtn').addEventListener('click', () => {
                console.log('ðŸ”„ Manual refresh triggered for incoming');
                loadIncomingGatePasses();
            });
            
            document.getElementById('incomingDetailsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                window.saveIncomingDetails();
            });
            document.getElementById('cancelIncomingDetails').addEventListener('click', function() {
                document.getElementById('incomingDetailsModal').style.display = 'none';
            });

            // Enhanced Payment Management Functions
            let enhancedPayments = [];
            let filteredEnhancedPayments = [];

            // Enhanced functions for the new UI
            function clearAllFiltersEnhanced() {
                document.getElementById('paymentStatusFilter').value = 'all';
                document.getElementById('brokerFilter').value = 'all';
                document.getElementById('dueDateFilter').value = '';
                document.getElementById('amountRangeFilter').value = 'all';
                document.getElementById('gatePassIdSearch').value = '';
                
                filteredEnhancedPayments = applyEnhancedFilters(enhancedPayments);
                renderEnhancedPaymentsTable(filteredEnhancedPayments);
            }

            function toggleAdvancedSearchEnhanced() {
                const panel = document.getElementById('advancedSearchPanel');
                const button = event.target;
                
                if (panel.classList.contains('hidden')) {
                    panel.classList.remove('hidden');
                    button.textContent = 'Hide Advanced Search';
                    button.classList.remove('bg-blue-600');
                    button.classList.add('bg-gray-600');
                } else {
                    panel.classList.add('hidden');
                    button.textContent = 'Advanced Search';
                    button.classList.remove('bg-gray-600');
                    button.classList.add('bg-blue-600');
                }
            }

            function addNewPaymentEnhanced() {
                // Use existing payment modal
                openPaymentModal();
            }

            function exportPaymentsEnhanced() {
                const csvContent = [
                    ['Gate Pass ID', 'Broker/Party', 'Grain Type', 'Amount Paid', 'Total Amount', 'Status', 'Due Date'],
                    ...filteredEnhancedPayments.map(p => [
                        p.gatePassId,
                        p.brokerName,
                        safeDisplay(p.grainType, 'Not Specified'),
                        p.amountPaid,
                        p.totalAmount,
                        p.status,
                        formatDate(p.dueDate)
                    ])
                ].map(row => row.join(',')).join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `payment_export_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                showNotification('Payment data exported successfully!', 'success');
            }

            // Apply enhanced filters
            function applyEnhancedFilters(payments) {
                const statusFilter = document.getElementById('paymentStatusFilter').value;
                const brokerFilter = document.getElementById('brokerFilter').value;
                const dueDateFilter = document.getElementById('dueDateFilter').value;
                const amountRangeFilter = document.getElementById('amountRangeFilter').value;
                const gatePassIdSearch = document.getElementById('gatePassIdSearch').value.toLowerCase();
                const searchInput = '';

                return payments.filter(payment => {
                    // Status filter
                    if (statusFilter !== 'all') {
                        if (statusFilter === 'overdue' && payment.status !== 'overdue') return false;
                        if (statusFilter === 'pending' && payment.status !== 'pending') return false;
                        if (statusFilter === 'partial' && payment.status !== 'partial') return false;
                        if (statusFilter === 'received' && payment.status !== 'received') return false;
                    }

                    // Broker filter
                    if (brokerFilter !== 'all' && payment.brokerName !== brokerFilter) return false;

                    // Due date filter
                    if (dueDateFilter && payment.dueDate && !isNaN(payment.dueDate.getTime()) && payment.dueDate.toISOString().split('T')[0] !== dueDateFilter) return false;

                    // Amount range filter
                    if (amountRangeFilter !== 'all') {
                        const amount = payment.totalAmount;
                        switch (amountRangeFilter) {
                            case '0-10000':
                                if (amount < 0 || amount > 10000) return false;
                                break;
                            case '10000-50000':
                                if (amount < 10000 || amount > 50000) return false;
                                break;
                            case '50000-100000':
                                if (amount < 50000 || amount > 100000) return false;
                                break;
                            case '100000+':
                                if (amount < 100000) return false;
                                break;
                        }
                    }

                    // Gate pass ID search
                    if (gatePassIdSearch && !payment.gatePassId.toLowerCase().includes(gatePassIdSearch)) return false;


                    return true;
                });
            }

            // Render enhanced payments table
            function renderEnhancedPaymentsTable(payments) {
                const tbody = document.getElementById('duePaymentsTableBody');
                tbody.innerHTML = '';
                
                if (payments.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-8 py-16 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <span class="text-5xl mb-4">ðŸ“Š</span>
                                    <p class="text-xl font-medium mb-2">No payments found</p>
                                    <p class="text-sm text-gray-400">Try adjusting your filters or add some sample data</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                payments.forEach(payment => {
                    const progressPercentage = Math.round((payment.amountPaid / payment.totalAmount) * 100);
                    const statusClass = payment.status === 'received' ? 'bg-green-100 text-green-800' : 
                                      payment.status === 'overdue' ? 'bg-red-100 text-red-800' : 
                                      payment.status === 'partial' ? 'bg-orange-100 text-orange-800' :
                                      'bg-yellow-100 text-yellow-800';
                    
                    const row = `
                        <tr class="hover:bg-gray-50 transition-colors duration-200">
                            <td class="px-8 py-4 text-gray-900 font-medium whitespace-nowrap">${payment.gatePassId}</td>
                            <td class="px-8 py-4 text-gray-700 whitespace-nowrap">${payment.brokerName}</td>
                            <td class="px-8 py-4 text-gray-700 whitespace-nowrap">${safeDisplay(payment.grainType, 'Not Specified')}</td>
                            <td class="px-8 py-4 text-gray-700 whitespace-nowrap">â‚¹${payment.amountPaid.toLocaleString()} / â‚¹${payment.totalAmount.toLocaleString()}</td>
                            <td class="px-8 py-4 text-gray-500 whitespace-nowrap">${formatDate(payment.dueDate)}</td>
                            <td class="px-8 py-4 whitespace-nowrap">
                                <span class="px-3 py-1 inline-flex text-xs font-semibold leading-5 rounded-full ${statusClass}">
                                    ${payment.status.charAt(0).toUpperCase() + payment.status.slice(1)}
                                </span>
                            </td>
                            <td class="px-8 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-20 bg-gray-200 rounded-full h-2 mr-3">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: ${progressPercentage}%"></div>
                                    </div>
                                    <span class="text-sm text-gray-500 font-medium">${progressPercentage}%</span>
                                </div>
                            </td>
                            <td class="px-8 py-4 whitespace-nowrap">
                                <div class="flex space-x-3">
                                    <button onclick="openPaymentModal('${payment.gatePassId}')" 
                                            class="px-3 py-1 text-blue-600 hover:text-blue-900 text-sm font-medium hover:bg-blue-50 rounded-md transition-colors">Manage</button>
                                    <button onclick="viewPaymentDetails('${payment.gatePassId}')" 
                                            class="px-3 py-1 text-gray-600 hover:text-gray-900 text-sm font-medium hover:bg-gray-50 rounded-md transition-colors">View</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            }

            // Update enhanced summary cards with progress indicators
            function updateEnhancedSummaryCards() {
                let totalReceived = 0;
                let paidCount = 0;
                let pendingCount = 0;
                let partialCount = 0;
                let overdueCount = 0;
                let totalAmount = 0;

                enhancedPayments.forEach(payment => {
                    totalReceived += payment.amountPaid;
                    totalAmount += payment.totalAmount;
                    
                    if (payment.status === 'received') {
                        paidCount++;
                    } else if (payment.status === 'overdue') {
                        overdueCount++;
                    } else if (payment.status === 'partial') {
                        partialCount++;
                    } else {
                        pendingCount++;
                    }
                });

                // Update amounts
                document.getElementById('receivedAmount').textContent = `â‚¹${totalReceived.toLocaleString()}`;
                document.getElementById('overdueAmount').textContent = `â‚¹${enhancedPayments.filter(p => p.status === 'overdue').reduce((sum, p) => sum + p.totalAmount, 0).toLocaleString()}`;
                document.getElementById('pendingAmount').textContent = `â‚¹${enhancedPayments.filter(p => p.status === 'pending').reduce((sum, p) => sum + p.totalAmount, 0).toLocaleString()}`;
                document.getElementById('partialAmount').textContent = `â‚¹${enhancedPayments.filter(p => p.status === 'partial').reduce((sum, p) => sum + p.totalAmount, 0).toLocaleString()}`;

                // Update counts
                document.getElementById('receivedCount').textContent = paidCount;
                document.getElementById('overdueCount').textContent = overdueCount;
                document.getElementById('pendingCount').textContent = pendingCount;
                document.getElementById('partialCount').textContent = partialCount;

                // Update progress bars
                const receivedProgress = totalAmount > 0 ? (totalReceived / totalAmount) * 100 : 0;
                const overdueProgress = totalAmount > 0 ? (enhancedPayments.filter(p => p.status === 'overdue').reduce((sum, p) => sum + p.totalAmount, 0) / totalAmount) * 100 : 0;
                const pendingProgress = totalAmount > 0 ? (enhancedPayments.filter(p => p.status === 'pending').reduce((sum, p) => sum + p.totalAmount, 0) / totalAmount) * 100 : 0;
                const partialProgress = totalAmount > 0 ? (enhancedPayments.filter(p => p.status === 'partial').reduce((sum, p) => sum + p.totalAmount, 0) / totalAmount) * 100 : 0;

                document.getElementById('receivedProgress').style.width = `${receivedProgress}%`;
                document.getElementById('overdueProgress').style.width = `${overdueProgress}%`;
                document.getElementById('pendingProgress').style.width = `${pendingProgress}%`;
                document.getElementById('partialProgress').style.width = `${partialProgress}%`;
            }

            // Load enhanced payment data
            function loadEnhancedPaymentData() {
                console.log("ðŸ”„ Loading enhanced payment data from gate passes");
                
                enhancedPayments = [];
                
                // Process all gate passes to create payment records
                allGatePasses.forEach(gatePass => {
                    if (gatePass.type === 'Outgoing' && gatePass.itemRate && gatePass.outgoingPartyWeight) {
                        const totalAmount = gatePass.itemRate * gatePass.outgoingPartyWeight;
                        const paymentHistory = gatePass.paymentHistory || [];
                        const totalReceived = paymentHistory.reduce((sum, p) => sum + (p.amount || 0), 0);
                        
                        // Calculate due date (30 days from gate pass date)
                        console.log('ðŸ” DEBUG: Date calculation for gate pass:', {
                            id: gatePass.id,
                            originalDate: gatePass.date,
                            dateObject: new Date(gatePass.date),
                            isValidDate: !isNaN(new Date(gatePass.date).getTime())
                        });
                        
                        const dueDate = new Date(gatePass.date);
                        if (isNaN(dueDate.getTime())) {
                            console.error('âŒ Invalid date for gate pass:', gatePass.id, 'Date:', gatePass.date);
                            return; // Skip this gate pass if date is invalid
                        }
                        dueDate.setDate(dueDate.getDate() + 30);
                        
                        const today = new Date();
                        const daysOverdue = Math.max(0, Math.floor((today - dueDate) / (1000 * 60 * 60 * 24)));
                        
                        let status = 'pending';
                        if (totalReceived >= totalAmount) {
                            status = 'received';
                        } else if (totalReceived > 0) {
                            status = 'partial';
                        } else if (daysOverdue > 0) {
                            status = 'overdue';
                        }

                        // Debug logging for grain type
                        console.log('ðŸ” DEBUG: Gate pass item data:', {
                            id: gatePass.id,
                            item: gatePass.item,
                            itemName: gatePass.itemName,
                            brokerName: gatePass.brokerName
                        });

                        const paymentData = {
                            id: gatePass.id,
                            gatePassId: gatePass.id,
                            brokerName: gatePass.brokerName || 'N/A',
                            grainType: gatePass.item || 'Not Specified',
                            amountPaid: totalReceived,
                            totalAmount: totalAmount,
                            dueDate: dueDate,
                            status: status,
                            daysOverdue: daysOverdue,
                            paymentHistory: paymentHistory,
                            originalGatePass: gatePass
                        };

                        enhancedPayments.push(paymentData);
                    }
                });

                // Apply filters and render
                filteredEnhancedPayments = applyEnhancedFilters(enhancedPayments);
                renderEnhancedPaymentsTable(filteredEnhancedPayments);
                updateEnhancedSummaryCards();
                updateBrokerFilterEnhanced();
                
                console.log("âœ… Enhanced payment data loaded:", enhancedPayments.length, "payments");
            }

            // Update broker filter for enhanced UI
            function updateBrokerFilterEnhanced() {
                const brokers = [...new Set(enhancedPayments.map(p => p.brokerName).filter(Boolean))];
                const brokerSelect = document.getElementById('brokerFilter');
                
                brokerSelect.innerHTML = '<option value="all">All Brokers</option>';
                brokers.forEach(broker => {
                    brokerSelect.innerHTML += `<option value="${broker}">${broker}</option>`;
                });
            }

            // Make enhanced functions globally accessible
            window.clearAllFiltersEnhanced = clearAllFiltersEnhanced;
            window.toggleAdvancedSearchEnhanced = toggleAdvancedSearchEnhanced;
            window.addNewPaymentEnhanced = addNewPaymentEnhanced;
            window.exportPaymentsEnhanced = exportPaymentsEnhanced;
            window.loadEnhancedPaymentData = loadEnhancedPaymentData;

            // Add event listeners for enhanced filters
            document.addEventListener('DOMContentLoaded', function() {
                const enhancedFilters = [
                    'paymentStatusFilter',
                    'brokerFilter', 
                    'dueDateFilter',
                    'amountRangeFilter',
                    'gatePassIdSearch',
                ];
                
                enhancedFilters.forEach(filterId => {
                    const element = document.getElementById(filterId);
                    if (element) {
                        element.addEventListener('change', () => {
                            filteredEnhancedPayments = applyEnhancedFilters(enhancedPayments);
                            renderEnhancedPaymentsTable(filteredEnhancedPayments);
                        });
                        element.addEventListener('input', () => {
                            filteredEnhancedPayments = applyEnhancedFilters(enhancedPayments);
                            renderEnhancedPaymentsTable(filteredEnhancedPayments);
                        });
                    }
                });
            });

            // Payment Management Functions



            function renderDuePaymentsTable(payments) {
                console.log("ðŸ”„ Rendering payments table with", payments.length, "payments");
                console.log("ðŸ”„ Payments data:", payments);
                
                const tbody = document.getElementById('duePaymentsTableBody');
                tbody.innerHTML = '';
                
                if (payments.length === 0) {
                    console.log("âš ï¸ No payments to render");
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                                No payments found matching the current filters.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                payments.forEach(payment => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    const statusBadge = getPaymentStatusBadge(payment);
                    const daysOverdueText = payment.daysOverdue > 0 ? `${payment.daysOverdue} days overdue` : 'On time';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${payment.id}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${payment.item}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${payment.purchasedFrom}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${payment.brokerName}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="font-semibold">â‚¹${payment.totalAmount.toLocaleString()}</div>
                            ${payment.paymentStatus === 'partial' ? `
                                <div class="text-xs text-gray-500">
                                    Received: â‚¹${payment.amountReceived.toLocaleString()}<br>
                                    Remaining: â‚¹${payment.remainingAmount.toLocaleString()}
                                </div>
                            ` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${payment.paymentDueDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${statusBadge}
                            ${payment.daysOverdue > 0 ? `<div class="text-xs text-red-600">${daysOverdueText}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="openPaymentStatusModal('${payment.id}')" 
                                    class="text-blue-600 hover:text-blue-900 mr-3">
                                Update Status
                            </button>
                            <button onclick="viewPaymentDetails('${payment.id}')" 
                                    class="text-gray-600 hover:text-gray-900">
                                View Details
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }

            function getPaymentStatusBadge(payment) {
                if (payment.paymentStatus === 'received') {
                    return '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Fully Received</span>';
                } else if (payment.paymentStatus === 'partial') {
                    return '<span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">Partial Payment</span>';
                } else if (payment.daysOverdue > 0) {
                    return '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">Overdue</span>';
                } else {
                    return '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">Pending</span>';
                }
            }

            // Make functions globally accessible
            window.openPaymentStatusModal = function(gatePassId) {
                const gatePass = allGatePasses.find(gp => gp.id === gatePassId);
                if (!gatePass) return;
                
                const totalAmount = gatePass.itemRate * gatePass.outgoingPartyWeight;
                const paymentHistory = gatePass.paymentHistory || [];
                const totalReceived = paymentHistory.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                const remainingAmount = totalAmount - totalReceived;
                
                // Determine current status
                let paymentStatus = 'pending';
                if (totalReceived >= totalAmount) {
                    paymentStatus = 'received';
                } else if (totalReceived > 0) {
                    paymentStatus = 'partial';
                }
                
                document.getElementById('paymentGatePassId').value = gatePassId;
                document.getElementById('paymentGatePassIdDisplay').value = gatePassId;
                document.getElementById('paymentAmountDisplay').value = `â‚¹${totalAmount.toLocaleString()}`;
                document.getElementById('paymentBrokerDisplay').value = gatePass.brokerName;
                document.getElementById('paymentDueDateDisplay').value = gatePass.paymentDueDate;
                document.getElementById('paymentReceivedDate').value = '';
                document.getElementById('amountReceived').value = '';
                document.getElementById('remainingAmount').value = `â‚¹${remainingAmount.toLocaleString()}`;
                document.getElementById('paymentStatusDisplay').value = paymentStatus.charAt(0).toUpperCase() + paymentStatus.slice(1);
                document.getElementById('paymentNotes').value = '';
                
                // Populate payment history
                populatePaymentHistory(paymentHistory, totalAmount);
                
                document.getElementById('paymentStatusModal').style.display = 'flex';
            };

            window.viewPaymentDetails = function(gatePassId) {
                editOutgoingDetails(gatePassId);
            };

            function populatePaymentHistory(paymentHistory, totalAmount) {
                const historyContainer = document.getElementById('paymentHistoryList');
                
                if (paymentHistory.length === 0) {
                    historyContainer.innerHTML = '<p class="text-gray-500 text-center py-2">No payments received yet</p>';
                    return;
                }
                
                // Sort payments by date (newest first)
                const sortedPayments = [...paymentHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                historyContainer.innerHTML = sortedPayments.map((payment, index) => {
                    const paymentNumber = sortedPayments.length - index;
                    const runningTotal = sortedPayments.slice(0, index + 1).reduce((sum, p) => sum + p.amount, 0);
                    const remainingAfter = totalAmount - runningTotal;
                    
                    return `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-medium text-gray-700">Payment #${paymentNumber}</span>
                                    <span class="text-xs text-gray-500">${payment.date}</span>
                                </div>
                                <div class="text-sm text-gray-600">Amount: â‚¹${payment.amount.toLocaleString()}</div>
                                ${payment.notes ? `<div class="text-xs text-gray-500">${payment.notes}</div>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium text-gray-700">Total: â‚¹${runningTotal.toLocaleString()}</div>
                                <div class="text-xs text-gray-500">Remaining: â‚¹${remainingAfter.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            window.savePaymentStatus = function() {
                const gatePassId = document.getElementById('paymentGatePassId').value;
                const paymentReceivedDate = document.getElementById('paymentReceivedDate').value;
                const amountReceived = parseFloat(document.getElementById('amountReceived').value) || 0;
                const paymentNotes = document.getElementById('paymentNotes').value.trim();
                
                // Find the gate pass to get total amount
                const gatePass = allGatePasses.find(gp => gp.id === gatePassId);
                if (!gatePass) return;
                
                const totalAmount = gatePass.itemRate * gatePass.outgoingPartyWeight;
                
                // Validation
                if (!paymentReceivedDate) {
                    showNotification('Please select payment received date', 'error');
                    return;
                }
                
                if (amountReceived <= 0) {
                    showNotification('Please enter amount received', 'error');
                    return;
                }
                
                // Get current payment history
                const currentHistory = gatePass.paymentHistory || [];
                const totalReceived = currentHistory.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                const newTotal = totalReceived + amountReceived;
                
                if (newTotal > totalAmount) {
                    showNotification(`Total payments cannot exceed total amount. Maximum allowed: â‚¹${(totalAmount - totalReceived).toLocaleString()}`, 'error');
                    return;
                }
                
                // Find and update the gate pass
                const gatePassIndex = allGatePasses.findIndex(gp => gp.id === gatePassId);
                if (gatePassIndex !== -1) {
                    // Add new payment to history
                    const newPayment = {
                        id: Date.now().toString(), // Simple ID generation
                        amount: amountReceived,
                        date: paymentReceivedDate,
                        notes: paymentNotes,
                        addedBy: currentUser.name,
                        addedAt: new Date().toISOString()
                    };
                    
                    // Update payment history
                    allGatePasses[gatePassIndex].paymentHistory = [...currentHistory, newPayment];
                    
                    // Calculate payment status
                    let paymentStatus = 'pending';
                    if (newTotal >= totalAmount) {
                        paymentStatus = 'received';
                    } else if (newTotal > 0) {
                        paymentStatus = 'partial';
                    }
                    
                    // Update calculated fields
                    allGatePasses[gatePassIndex].amountReceived = newTotal;
                    allGatePasses[gatePassIndex].paymentStatus = paymentStatus;
                    allGatePasses[gatePassIndex].lastUpdatedBy = currentUser.name;
                    allGatePasses[gatePassIndex].lastUpdatedAt = new Date().toISOString();
                    
                    // Update in Firebase
                    updatePaymentStatusInFirebase(allGatePasses[gatePassIndex]);
                    
                    // Refresh displays
                    loadDuePayments();
                    
                    // Close modal
                    document.getElementById('paymentStatusModal').style.display = 'none';
                    
                    showNotification(`Payment of â‚¹${amountReceived.toLocaleString()} added successfully`, 'success');
                }
            };

            // Function to update payment status in Firebase
            async function updatePaymentStatusInFirebase(gatePass) {
                try {
                    if (gatePass.firebaseId && db) {
                        const gatePassRef = doc(db, 'gate_passes', gatePass.firebaseId);
                        
                        // Prepare update data, filtering out undefined values
                        const updateData = {};
                        if (gatePass.paymentStatus !== undefined) updateData.paymentStatus = gatePass.paymentStatus;
                        if (gatePass.amountReceived !== undefined) updateData.amountReceived = gatePass.amountReceived;
                        if (gatePass.paymentHistory !== undefined) updateData.paymentHistory = gatePass.paymentHistory;
                        if (gatePass.lastUpdatedBy !== undefined) updateData.lastUpdatedBy = gatePass.lastUpdatedBy;
                        if (gatePass.lastUpdatedAt !== undefined) updateData.lastUpdatedAt = gatePass.lastUpdatedAt;
                        
                        await updateDoc(gatePassRef, updateData);
                        console.log('âœ… Payment status updated in Firebase');
                    }
                } catch (error) {
                    console.error('âŒ Error updating payment status in Firebase:', error);
                }
            }

            // Event listeners for payment management
            document.getElementById('paymentStatusFilter').addEventListener('change', loadDuePayments);
            document.getElementById('brokerFilter').addEventListener('change', loadDuePayments);
            document.getElementById('dueDateFilter').addEventListener('change', loadDuePayments);
            document.getElementById('paymentStatusForm').addEventListener('submit', function(e) {
                e.preventDefault();
                window.savePaymentStatus();
            });
            document.getElementById('cancelPaymentStatus').addEventListener('click', function() {
                document.getElementById('paymentStatusModal').style.display = 'none';
            });

            // Real-time calculation for remaining amount
            document.getElementById('amountReceived').addEventListener('input', function() {
                const gatePassId = document.getElementById('paymentGatePassId').value;
                const gatePass = allGatePasses.find(gp => gp.id === gatePassId);
                if (gatePass) {
                    const totalAmount = gatePass.itemRate * gatePass.outgoingPartyWeight;
                    const currentHistory = gatePass.paymentHistory || [];
                    const totalReceived = currentHistory.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                    const newAmount = parseFloat(this.value) || 0;
                    const remainingAmount = totalAmount - (totalReceived + newAmount);
                    document.getElementById('remainingAmount').value = `â‚¹${remainingAmount.toLocaleString()}`;
                }
            });
        };
    </script>
</body>
</html>


