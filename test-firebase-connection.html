<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Connection Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f5f5f5;
        }
        .test-container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-weight: bold; 
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        button { 
            background-color: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background-color: #0056b3; }
        #console { 
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 15px; 
            border-radius: 4px; 
            font-family: monospace; 
            height: 300px; 
            overflow-y: auto; 
            white-space: pre-wrap; 
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üî• Firebase Connection Test</h1>
        <p>This tool tests if your Firebase security rules fix is working correctly.</p>
        
        <div id="status" class="status info">Ready to test Firebase connection...</div>
        
        <button onclick="testFirebaseConnection()">üß™ Test Firebase Connection</button>
        <button onclick="testDataWrite()">üìù Test Data Write</button>
        <button onclick="testDataRead()">üìñ Test Data Read</button>
        <button onclick="clearConsole()">üßπ Clear Console</button>
        
        <h3>Console Output:</h3>
        <div id="console"></div>
        
        <h3>Expected Results After Fix:</h3>
        <ul>
            <li>‚úÖ <strong>Authentication:</strong> Should succeed with anonymous login</li>
            <li>‚úÖ <strong>Write Test:</strong> Should successfully add test document</li>
            <li>‚úÖ <strong>Read Test:</strong> Should read documents without errors</li>
            <li>‚úÖ <strong>No Permission Errors:</strong> No "permission-denied" messages</li>
        </ul>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Same Firebase config as your main app
        const firebaseConfig = {
            apiKey: "AIzaSyBdjQoKx1ORU3gCvK5-JP6dGfg1xkqL8Lk",
            authDomain: "gatepass-146df.firebaseapp.com",
            projectId: "gatepass-146df",
            storageBucket: "gatepass-146df.firebasestorage.app",
            messagingSenderId: "343259089109",
            appId: "1:343259089109:web:6ed2be22cb568e5e053a5c",
            measurementId: "G-58KPYJ7EP1"
        };

        let app, auth, db;

        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            console.textContent += `[${timestamp}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
            
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }

        // Initialize Firebase
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            log("‚úÖ Firebase initialized successfully", 'success');
        } catch (error) {
            log(`‚ùå Firebase initialization failed: ${error.message}`, 'error');
        }

        window.testFirebaseConnection = async function() {
            log("üîÑ Testing Firebase connection...", 'info');
            
            try {
                // Test authentication
                log("üîë Testing authentication...");
                const userCredential = await signInAnonymously(auth);
                log(`‚úÖ Authentication successful: ${userCredential.user.uid}`, 'success');
                
                log("üéâ Firebase connection test completed successfully!", 'success');
                
            } catch (error) {
                log(`‚ùå Firebase connection failed: ${error.code} - ${error.message}`, 'error');
                
                if (error.code === 'permission-denied') {
                    log("üí° SOLUTION: Update Firebase Security Rules (see firebase-setup-guide.md)", 'warning');
                }
            }
        }

        window.testDataWrite = async function() {
            log("üìù Testing data write permissions...", 'info');
            
            try {
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
                
                const testData = {
                    test: true,
                    message: "Firebase connection test",
                    timestamp: new Date(),
                    type: "connection_test"
                };
                
                const docRef = await addDoc(collection(db, 'connection_test'), testData);
                log(`‚úÖ Write test successful! Document ID: ${docRef.id}`, 'success');
                
                // Clean up test document
                await deleteDoc(docRef);
                log("üßπ Test document cleaned up", 'info');
                
            } catch (error) {
                log(`‚ùå Write test failed: ${error.code} - ${error.message}`, 'error');
                
                if (error.code === 'permission-denied') {
                    log("üö´ Permission denied - Update Firebase Security Rules!", 'error');
                } else if (error.code === 'failed-precondition') {
                    log("‚öôÔ∏è Firestore not enabled - Enable Firestore in Firebase Console", 'error');
                }
            }
        }

        window.testDataRead = async function() {
            log("üìñ Testing data read permissions...", 'info');
            
            try {
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
                
                const querySnapshot = await getDocs(collection(db, 'gate_passes'));
                log(`‚úÖ Read test successful! Found ${querySnapshot.size} gate passes`, 'success');
                
            } catch (error) {
                log(`‚ùå Read test failed: ${error.code} - ${error.message}`, 'error');
                
                if (error.code === 'permission-denied') {
                    log("üö´ Permission denied - Update Firebase Security Rules!", 'error');
                }
            }
        }

        window.clearConsole = function() {
            document.getElementById('console').textContent = '';
            log("Console cleared", 'info');
        }

        // Auto-run basic connection test on load
        window.addEventListener('load', () => {
            setTimeout(testFirebaseConnection, 1000);
        });
    </script>
</body>
</html>
